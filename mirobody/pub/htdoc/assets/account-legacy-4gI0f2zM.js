System.register(["./index-legacy-BCYsgP_m.js","./vendor-antd-legacy-B_nlExEM.js"],function(e,t){"use strict";var n,r,s,o,i,a,c,l,u,d,f,h,p,g,m,_,w,b,v;return{setters:[e=>{n=e.a,r=e.v,s=e.A,o=e.r,i=e.P,a=e.a0,c=e.a1,l=e.a2,u=e.M,d=e.G,f=e.o,h=e.q,p=e.b,g=e.a3,m=e.a4,_=e.a5,w=e.a6,b=e.a7},e=>{v=e.e}],execute:function(){e("g",he),Promise.resolve(!1);var t=Promise.resolve(!0),y=Promise.resolve();function S(e,t){return e||(e=0),new Promise(function(n){return setTimeout(function(){return n(t)},e)})}function C(){return Math.random().toString(36).substring(2)}var I=0;function L(){var e=1e3*Date.now();return e<=I&&(e=I+1),I=e,e}var k={create:function(e){var t={time:L(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return t.bc.onmessage=function(e){t.messagesCallback&&t.messagesCallback(e.data)},t},close:function(e){e.bc.close(),e.subFns=[]},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){try{return e.bc.postMessage(t,!1),y}catch(n){return Promise.reject(n)}},canBeUsed:function(){if("undefined"!=typeof globalThis&&globalThis.Deno&&globalThis.Deno.args)return!0;if("undefined"==typeof window&&"undefined"==typeof self||"function"!=typeof BroadcastChannel)return!1;if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0},type:"native",averageResponseTime:function(){return 150},microSeconds:L};class E{ttl;map=new Map;_to=!1;constructor(e){this.ttl=e}has(e){const t=this.map.get(e);return!(void 0===t||t<P()-this.ttl&&(this.map.delete(e),1))}add(e){this.map.delete(e),this.map.set(e,P()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,function(e){const t=P()-e.ttl,n=e.map[Symbol.iterator]();for(;;){const r=n.next().value;if(!r)break;const s=r[0];if(!(r[1]<t))break;e.map.delete(s)}}(this)},0))}clear(){this.map.clear()}}function P(){return Date.now()}function M(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=JSON.parse(JSON.stringify(e));return void 0===t.webWorkerSupport&&(t.webWorkerSupport=!0),t.idb||(t.idb={}),t.idb.ttl||(t.idb.ttl=45e3),t.idb.fallbackInterval||(t.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(t.idb.onclose=e.idb.onclose),t.localstorage||(t.localstorage={}),t.localstorage.removeTimeout||(t.localstorage.removeTimeout=6e4),e.methods&&(t.methods=e.methods),t.node||(t.node={}),t.node.ttl||(t.node.ttl=12e4),t.node.maxParallelWrites||(t.node.maxParallelWrites=2048),void 0===t.node.useFastPath&&(t.node.useFastPath=!0),t}var W="messages",O={durability:"relaxed"};function N(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function D(e){e.commit&&e.commit()}function T(e,t){var n=e.transaction(W,"readonly",O),r=n.objectStore(W),s=[],o=IDBKeyRange.bound(t+1,1/0);if(r.getAll){var i=r.getAll(o);return new Promise(function(e,t){i.onerror=function(e){return t(e)},i.onsuccess=function(t){e(t.target.result)}})}return new Promise(function(e,i){var a=function(){try{return o=IDBKeyRange.bound(t+1,1/0),r.openCursor(o)}catch(e){return r.openCursor()}}();a.onerror=function(e){return i(e)},a.onsuccess=function(r){var o=r.target.result;o?o.value.id<t+1?o.continue(t+1):(s.push(o.value),o.continue()):(D(n),e(s))}})}function B(e){return(t=e.db,n=e.options.idb.ttl,r=Date.now()-n,s=t.transaction(W,"readonly",O),o=s.objectStore(W),i=[],new Promise(function(e){o.openCursor().onsuccess=function(t){var n=t.target.result;if(n){var o=n.value;o.time<r?(i.push(o),n.continue()):(D(s),e(i))}else e(i)}})).then(function(t){return function(e,t){if(e.closed)return Promise.resolve([]);var n=e.db.transaction(W,"readwrite",O).objectStore(W);return Promise.all(t.map(function(e){var t=n.delete(e);return new Promise(function(e){t.onsuccess=function(){return e()}})}))}(e,t.map(function(e){return e.id}))});var t,n,r,s,o,i}function F(e){e.closed||U(e).then(function(){return S(e.options.idb.fallbackInterval)}).then(function(){return F(e)})}function U(e){return e.closed?y:e.messagesCallback?T(e.db,e.lastCursorId).then(function(t){var n=t.filter(function(e){return!!e}).map(function(t){return t.id>e.lastCursorId&&(e.lastCursorId=t.id),t}).filter(function(t){return function(e,t){return!(e.uuid===t.uuid||t.eMIs.has(e.id)||e.data.time<t.messagesCallbackTime)}(t,e)}).sort(function(e,t){return e.time-t.time});return n.forEach(function(t){e.messagesCallback&&(e.eMIs.add(t.id),e.messagesCallback(t.data))}),y}):y}var x={create:function(e,t){return t=M(t),function(e){var t="pubkey.broadcast-channel-0-"+e,n=N().open(t);return n.onupgradeneeded=function(e){e.target.result.createObjectStore(W,{keyPath:"id",autoIncrement:!0})},new Promise(function(e,t){n.onerror=function(e){return t(e)},n.onsuccess=function(){e(n.result)}})}(e).then(function(n){var r={closed:!1,lastCursorId:0,channelName:e,options:t,uuid:C(),eMIs:new E(2*t.idb.ttl),writeBlockPromise:y,messagesCallback:null,readQueuePromises:[],db:n};return n.onclose=function(){r.closed=!0,t.idb.onclose&&t.idb.onclose()},F(r),r})},close:function(e){e.closed=!0,e.db.close()},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t,U(e)},postMessage:function(e,t){return e.writeBlockPromise=e.writeBlockPromise.then(function(){return function(e,t,n){var r={uuid:t,time:Date.now(),data:n},s=e.transaction([W],"readwrite",O);return new Promise(function(e,t){s.oncomplete=function(){return e()},s.onerror=function(e){return t(e)},s.objectStore(W).add(r),D(s)})}(e.db,e.uuid,t)}).then(function(){var t,n;0===(t=0,n=10,Math.floor(Math.random()*(n-t+1)+t))&&B(e)}),e.writeBlockPromise},canBeUsed:function(){return!!N()},type:"idb",averageResponseTime:function(e){return 2*e.idb.fallbackInterval},microSeconds:L};function R(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(t){}return e}function A(e){return"pubkey.broadcastChannel-"+e}function z(){var e=R();if(!e)return!1;try{var t="__broadcastchannel_check";e.setItem(t,"works"),e.removeItem(t)}catch(n){return!1}return!0}var K={create:function(e,t){if(t=M(t),!z())throw new Error("BroadcastChannel: localstorage cannot be used");var n=C(),r=new E(t.localstorage.removeTimeout),s={channelName:e,uuid:n,eMIs:r};return s.listener=function(e,t){var n=A(e),r=function(e){e.key===n&&t(JSON.parse(e.newValue))};return window.addEventListener("storage",r),r}(e,function(e){s.messagesCallback&&e.uuid!==n&&e.token&&!r.has(e.token)&&(e.data.time&&e.data.time<s.messagesCallbackTime||(r.add(e.token),s.messagesCallback(e.data)))}),s},close:function(e){var t;t=e.listener,window.removeEventListener("storage",t)},onMessage:function(e,t,n){e.messagesCallbackTime=n,e.messagesCallback=t},postMessage:function(e,t){return new Promise(function(n){S().then(function(){var r=A(e.channelName),s={token:C(),time:Date.now(),data:t,uuid:e.uuid},o=JSON.stringify(s);R().setItem(r,o);var i=document.createEvent("Event");i.initEvent("storage",!0,!0),i.key=r,i.newValue=o,window.dispatchEvent(i),n()})})},canBeUsed:z,type:"localstorage",averageResponseTime:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120},microSeconds:L},j=L,$=new Set,q={create:function(e){var t={time:j(),name:e,messagesCallback:null};return $.add(t),t},close:function(e){$.delete(e)},onMessage:function(e,t){e.messagesCallback=t},postMessage:function(e,t){return new Promise(function(n){return setTimeout(function(){Array.from($).forEach(function(n){n.name===e.name&&n!==e&&n.messagesCallback&&n.time<t.time&&n.messagesCallback(t)}),n()},5)})},canBeUsed:function(){return!0},type:"simulate",averageResponseTime:function(){return 5},microSeconds:j},Q=[k,x,K],G=new Set,J=0,Y=function(e,t){var n,r,s;this.id=J++,G.add(this),this.name=e,this.options=M(t),this.method=function(e){var t=[].concat(e.methods,Q).filter(Boolean);if(e.type){if("simulate"===e.type)return q;var n=t.find(function(t){return t.type===e.type});if(n)return n;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(t=t.filter(function(e){return"idb"!==e.type}));var r=t.find(function(e){return e.canBeUsed()});if(r)return r;throw new Error("No usable method found in "+JSON.stringify(Q.map(function(e){return e.type})))}(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,r=(n=this).method.create(n.name,n.options),(s=r)&&"function"==typeof s.then?(n._prepP=r,r.then(function(e){n._state=e})):n._state=r};function H(e,t,n){var r={time:e.method.microSeconds(),type:t,data:n};return(e._prepP?e._prepP:y).then(function(){var t=e.method.postMessage(e._state,r);return e._uMP.add(t),t.catch().then(function(){return e._uMP.delete(t)}),t})}function V(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function X(e,t,n){e._addEL[t].push(n),function(e){if(!e._iL&&V(e)){var t=function(t){e._addEL[t.type].forEach(function(e){t.time>=e.time&&e.fn(t.data)})},n=e.method.microSeconds();e._prepP?e._prepP.then(function(){e._iL=!0,e.method.onMessage(e._state,t,n)}):(e._iL=!0,e.method.onMessage(e._state,t,n))}}(e)}function Z(e,t,n){e._addEL[t]=e._addEL[t].filter(function(e){return e!==n}),function(e){if(e._iL&&!V(e)){e._iL=!1;var t=e.method.microSeconds();e.method.onMessage(e._state,null,t)}}(e)}Y._pubkey=!0,Y.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return H(this,"message",e)},postInternal:function(e){return H(this,"internal",e)},set onmessage(e){var t={time:this.method.microSeconds(),fn:e};Z(this,"message",this._onML),e&&"function"==typeof e?(this._onML=t,X(this,"message",t)):this._onML=null},addEventListener:function(e,t){X(this,e,{time:this.method.microSeconds(),fn:t})},removeEventListener:function(e,t){Z(this,e,this._addEL[e].find(function(e){return e.fn===t}))},close:function(){var e=this;if(!this.closed){G.delete(this),this.closed=!0;var t=this._prepP?this._prepP:y;return this._onML=null,this._addEL.message=[],t.then(function(){return Promise.all(Array.from(e._uMP))}).then(function(){return Promise.all(e._befC.map(function(e){return e()}))}).then(function(){return e.method.close(e._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};var ee="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)?function(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}},te=new Set,ne=!1;function re(e){if(ne||(ne=!0,ee(se)),"function"!=typeof e)throw new Error("Listener is no function");return te.add(e),{remove:function(){return te.delete(e)},run:function(){return te.delete(e),e()}}}function se(){var e=[];return te.forEach(function(t){e.push(t()),te.delete(t)}),Promise.all(e)}function oe(e,t){var n={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(n)}function ie(e){e.isLeader=!0,e._hasLeader=!0;var t=re(function(){return e.die()});e._unl.push(t);var n=function(t){"leader"===t.context&&"apply"===t.action&&oe(e,"tell"),"leader"!==t.context||"tell"!==t.action||e._dpLC||(e._dpLC=!0,e._dpL(),oe(e,"tell"))};return e.broadcastChannel.addEventListener("internal",n),e._lstns.push(n),oe(e,"tell")}var ae=function(e,t){var n=this;this.broadcastChannel=e,e._befC.push(function(){return n.die()}),this._options=t,this.isLeader=!1,this.isDead=!1,this.token=C(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+e.method.type+"||"+e.name};ae.prototype={hasLeader:function(){var e=this;return navigator.locks.query().then(function(t){var n=t.held?t.held.filter(function(t){return t.name===e.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var e=this;if(!this._wLMP){this._wKMC.c=new AbortController;var t=new Promise(function(t,n){e._wKMC.res=t,e._wKMC.rej=n});this._wLMP=new Promise(function(n,r){navigator.locks.request(e.lN,{signal:e._wKMC.c.signal},function(){return e._wKMC.c=void 0,ie(e),n(),t}).catch(function(t){e._wKMC.rej&&e._wKMC.rej(t),r(t)})})}return this._wLMP},set onduplicate(e){},die:function(){var e=this;return this._lstns.forEach(function(t){return e.broadcastChannel.removeEventListener("internal",t)}),this._lstns=[],this._unl.forEach(function(e){return e.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),oe(this,"death")}};var ce=function(e,t){var n=this;this.broadcastChannel=e,this._options=t,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=C(),this._aplQ=y,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var r=function(e){"leader"===e.context&&("death"===e.action&&(n._hasLeader=!1),"tell"===e.action&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",r),this._lstns.push(r)};function le(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=function(e,t){return e||(e={}),(e=JSON.parse(JSON.stringify(e))).fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}(t,e);var n="undefined"!=typeof navigator&&void 0!==navigator.locks&&"function"==typeof navigator.locks.request?new ae(e,t):new ce(e,t);return e._befC.push(function(){return n.die()}),e._leaderElector=n,n}ce.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(e){var n=this;return this.isLeader?S(0,!0):this.isDead?S(0,!1):this._aplQC>1?this._aplQ:(this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return function(){if(n.isLeader)return t;var r,s=!1,o=new Promise(function(e){r=function(){s=!0,e()}}),i=function(e){"leader"===e.context&&e.token!=n.token&&("apply"===e.action&&e.token>n.token&&r(),"tell"===e.action&&(r(),n._hasLeader=!0))};n.broadcastChannel.addEventListener("internal",i);var a=e?4*n._options.responseTime:n._options.responseTime;return oe(n,"apply").then(function(){return Promise.race([S(a),o.then(function(){return Promise.reject(new Error)})])}).then(function(){return oe(n,"apply")}).then(function(){return Promise.race([S(a),o.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return n.broadcastChannel.removeEventListener("internal",i),!s&&ie(n).then(function(){return!0})})}()}).then(function(){n._aplQC=n._aplQC-1}),this._aplQ.then(function(){return n.isLeader}))},awaitLeadership:function(){return this._aLP||(this._aLP=(e=this).isLeader?y:new Promise(function(t){var n=!1;function r(){n||(n=!0,e.broadcastChannel.removeEventListener("internal",o),t(!0))}e.applyOnce().then(function(){e.isLeader&&r()});var s=function(){return S(e._options.fallbackInterval).then(function(){if(!e.isDead&&!n)return e.isLeader?void r():e.applyOnce(!0).then(function(){e.isLeader?r():s()})})};s();var o=function(t){"leader"===t.context&&"death"===t.action&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&r()}))};e.broadcastChannel.addEventListener("internal",o),e._lstns.push(o)})),this._aLP;var e},set onduplicate(e){this._dpL=e},die:function(){var e=this;return this._lstns.forEach(function(t){return e.broadcastChannel.removeEventListener("internal",t)}),this._lstns=[],this._unl.forEach(function(e){return e.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,oe(this,"death")}};class ue{constructor(e){this.userId=e,this.ws=null,this.url=null,this.connectionId=null,this.readyState=WebSocket.CLOSED,this.pingInterval=null,this.reconnectAttempts=0,this.PING_INTERVAL=3e4,this.generateConnectionId()}generateConnectionId(){if(!this.userId)throw new Error("WebSocketConnection::userId is required");const e=`WEBSOCKET_CONNECTION_ID_${this.userId}`,t=localStorage.getItem(e);t&&t.startsWith(`${this.userId}_`)?this.connectionId=t:(this.connectionId=`${this.userId}_${r()}`,localStorage.setItem(e,this.connectionId))}getSocketUrl(){const e=localStorage.getItem(s),t=o();return e?(this.connectionId||this.generateConnectionId(),`${t.replace(/^http/,"ws")}/ws/upload-health-report?token=${e}&connectionId=${this.connectionId}`):(n.warn("WebSocketConnection::No ACCESS_TOKEN, cannot generate WebSocket URL"),null)}startHeartbeat(){this.pingInterval||(this.sendPing(),this.pingInterval=setInterval(()=>{this.sendPing()},this.PING_INTERVAL))}sendPing(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const t=JSON.stringify({type:"ping",timestamp:v().format("YYYY-MM-DDTHH:mm:ss.SSSSSS")});try{this.ws.send(t)}catch(e){n.error(`WebSocketConnection::Failed to send ping for user ${this.userId}, connectionId: ${this.connectionId}:`,e)}}}stopHeartbeat(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null)}disconnect(){this.stopHeartbeat(),this.ws&&(this.ws.close(),this.ws=null),this.readyState=WebSocket.CLOSED}}class de{constructor(){this.connections=new Map,this.messageChannel=null,this.leaderChannel=null,this.elector=null,this.listeners=new Set,this.leaderConnectionStates=new Map,this.connectResolvers=new Map,this.initBroadcastChannel()}initBroadcastChannel(){this.messageChannel=new Y("upload-websocket-messages"),this.leaderChannel=new Y("upload-websocket-leader"),this.elector=le(this.leaderChannel,{fallbackInterval:500,responseTime:500}),this.elector.onduplicate=()=>{n.warn("WebSocketManager::Duplicate leader detected!")},this.messageChannel.onmessage=e=>{this.handleBroadcastMessage(e)}}getConnection(e){return e?(this.connections.has(e)||this.connections.set(e,new ue(e)),this.connections.get(e)):(n.warn("WebSocketManager::No userId provided"),null)}getCurrentConnection(){const e=be.getState().current_drive_user_id||"";return this.getConnection(e)}async tryConnect(){const e=this.getCurrentConnection();if(!e)throw n.error("WebSocketManager::tryConnect - no current_drive_user_id"),new Error("ERROR:: tryConnect no connection");if(this.elector.isLeader||await this.elector.awaitLeadership(),!e.ws||e.ws.readyState!==WebSocket.OPEN){if(e.url=e.getSocketUrl(),!e.url)throw n.error("WebSocketManager::tryConnect - cannot generate URL"),new Error("ERROR:: tryConnect no URL");try{e.ws=new WebSocket(e.url),e.readyState=WebSocket.CONNECTING,e.ws.onopen=()=>{e.readyState=WebSocket.OPEN,e.reconnectAttempts=0,this.broadcastMessage({type:"connection_state",userId:e.userId,state:"open",readyState:WebSocket.OPEN,connectionId:e.connectionId}),this.notifyListeners("open",null,e.userId),e.startHeartbeat()},e.ws.onmessage=t=>{try{const n=JSON.parse(t.data);this.notifyListeners("message",n,e.userId),this.broadcastMessage({type:"message",userId:e.userId,payload:n})}catch(r){n.error("WebSocketManager::Failed to parse message:",r)}},e.ws.onerror=t=>{n.error("WebSocketManager::WebSocket error:",t),e.readyState=WebSocket.CLOSED,this.broadcastMessage({type:"connection_state",userId:e.userId,state:"error",readyState:WebSocket.CLOSED,connectionId:e.connectionId}),this.notifyListeners("error",t,e.userId)},e.ws.onclose=t=>{e.readyState=WebSocket.CLOSED,e.stopHeartbeat(),this.broadcastMessage({type:"connection_state",userId:e.userId,state:"close",readyState:WebSocket.CLOSED,connectionId:e.connectionId,code:t.code,reason:t.reason}),this.notifyListeners("close",t,e.userId)}}catch(t){n.error("WebSocketManager::Failed to create WebSocket:",t),e.readyState=WebSocket.CLOSED,this.broadcastMessage({type:"connection_state",userId:e.userId,state:"error",readyState:WebSocket.CLOSED,connectionId:e.connectionId}),this.notifyListeners("error",t,e.userId)}}}disconnect(e){let t=e;if(!t){const e=this.getCurrentConnection();e&&(t=e.userId)}const n=this.connections.get(t);n&&(n.disconnect(),this.broadcastMessage({type:"connection_state",userId:t,state:"close",readyState:WebSocket.CLOSED,connectionId:n.connectionId}))}sendMessage(e){const t=this.getCurrentConnection();if(t)if(this.elector.isLeader)if(t.ws&&t.ws.readyState===WebSocket.OPEN)try{const n="string"==typeof e?e:JSON.stringify(e);t.ws.send(n)}catch(r){n.error("WebSocketManager:: sendMessage :: Failed to send message:",r)}else n.error("WebSocketManager:: sendMessage :: WebSocket not connected, cannot send message");else this.broadcastMessage({type:"send_message_request",userId:t.userId,connectionId:t.connectionId,message:"string"==typeof e?e:JSON.stringify(e)});else n.error("WebSocketManager:: sendMessage :: Cannot send message - no current connection")}handleBroadcastMessage(e){if(e&&e.type)if("connection_state"===e.type){const t=e.userId,n=this.connections.get(t);n&&(n.readyState=e.readyState)}else if("message"===e.type){const t=e.userId;e.payload&&this.notifyListeners("message",e.payload,t)}else if("send_message_request"===e.type&&this.elector.isLeader&&e.message&&e.userId){const r=this.connections.get(e.userId);if(!r)return void n.error("WebSocketManager::Leader received message request for unknown user");if(r.ws&&r.ws.readyState===WebSocket.OPEN)try{r.ws.send(e.message)}catch(t){n.error(`WebSocketManager::Failed to forward message to WebSocket for user ${r.userId}:`,t)}else n.error(`WebSocketManager::WebSocket not connected for user ${r.userId}, cannot forward message`)}}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}notifyListeners(e,t,r){this.listeners.forEach(s=>{try{s(e,t,r)}catch(o){n.error("WebSocketManager::Listener error:",o)}})}broadcastMessage(e){if(this.messageChannel)try{this.messageChannel.postMessage(e)}catch{}}isConnected(){const e=this.getCurrentConnection();return e&&e.ws&&e.ws.readyState===WebSocket.OPEN}isConnecting(){const e=this.getCurrentConnection();return e&&e.ws&&e.ws.readyState===WebSocket.CONNECTING}async ensureConnected(){if(!be.getState().current_drive_user_id)throw new Error("No current_drive_user_id");return!this.elector?.isLeader||(this.isConnected()||await this.tryConnect(),!0)}getReadyState(){const e=this.getCurrentConnection();return e?e.readyState:WebSocket.CLOSED}getConnectionId(){const e=this.getCurrentConnection();return e?e.connectionId:null}cleanup(){for(const[e,t]of this.connections)t.disconnect();this.connections.clear(),this.messageChannel&&this.messageChannel.close(),this.leaderChannel&&this.leaderChannel.close(),this.elector&&this.elector.die()}}let fe=null;function he(){if(!fe&&(fe=new de,"undefined"!=typeof window)){const e=()=>{fe&&fe.elector?.isLeader&&fe.cleanup()};window.addEventListener("pagehide",e),window.addEventListener("beforeunload",e)}return fe}const pe=e("c",e=>e?e.includes("image")?i.IMAGE:e.includes("pdf")?i.PDF:e.includes("mp4")||e.includes("video")?i.MP4:"text/plain"===e?i.TEXT:ge(e)?i.EXCEL:i.FILE:null),ge=e=>["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/vnd.ms-excel.sheet.macroEnabled.12","application/vnd.ms-excel.sheet.binary.macroEnabled.12"].includes(e),me=(e("o",()=>new Promise((e,t)=>{try{const t=document.createElement("input");t.type="file",t.multiple=!0,t.accept="*/*",t.onchange=t=>{const n=[];for(const e of t.target.files)n.push({file:e,file_name:e.name,file_size:e.size,file_type:pe(e.type),original_file_type:e.type});e(n)},t.click()}catch(n){t(n)}})),e("f",e=>e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(2)} KB`:`${(e/1024/1024).toFixed(2)} MB`)),_e=(e("h",e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files;return t.length>0?Array.from(t).map(e=>({file:e,file_name:e.name,file_size:e.size,file_type:pe(e.type)})):[]}),e("v",async e=>{try{if(!e||0===e.length)throw new Error(a.FILES_EMPTY);for(const t of e)if(!(await _e(t))){if(t.file.size>c)throw new Error(a.FILE_SIZE_TOO_LARGE);if(!l.includes(t.file.type))throw new Error(a.FILE_TYPE_NOT_ALLOWED)}return e}catch(t){return new Promise((e,n)=>{t.message===a.FILES_EMPTY?u.confirm({isShowCancelButton:!1,title:d("upload_files_title"),content:d("please_select_at_least_one_file_to_upload"),onOk:()=>{n(t)}}):t.message===a.FILE_TYPE_NOT_ALLOWED?u.confirm({title:d("upload_files_title"),content:d("please_select_only_allowed_file_types"),onOk:()=>{n(t)},isShowCancelButton:!1}):t.message===a.FILE_SIZE_TOO_LARGE?u.confirm({title:d("upload_files_title"),content:d("please_select_files_smaller_than_20mb"),onOk:()=>{n(t)},isShowCancelButton:!1}):n(t)})}}),async e=>{try{return"text/plain"===e.file.type&&!!(await e.file.text()).startsWith("# This data file generated by WeGene at")}catch(t){return n.error("ERROR: isGeneticFile",t),!1}}),we=e("b",f(h((e,t)=>({_uploadedFilesController:null,file_list:[],total:0,total_size:0,currentPage:1,pageSize:10,uploading_files:new Map,isLoading:!1,addUploadingFile:(t,r,s)=>{e(e=>{const o=s||be.getState().current_drive_user_id||"";o?(e.uploading_files.has(o)||e.uploading_files.set(o,new Map),e.uploading_files.get(o).set(t,{...r,messageId:t,id:t,upload_status:"uploading",progress:0,message:"Starting upload...",isUploading:!0})):n.warn(`useUploadStore::addUploadingFile - No userId provided, messageId: ${t}`)})},updateUploadingProgress:(r,s,o,i,a)=>{e(e=>{const t=a||be.getState().current_drive_user_id||"";if(!t)return void n.warn("useUploadStore::updateUploadingProgress - No userId provided");const c=e.file_list.findIndex(e=>e.id===r);if(-1!==c){e.file_list[c].progress=s,e.file_list[c].upload_status=o,e.file_list[c].message=i;const n=e.uploading_files.get(t);n&&n.delete(r)}else{const n=e.uploading_files.get(t);if(n){const e=n.get(r);e&&(e.progress=s,e.upload_status=o,e.message=i)}}}),t().checkAndRefreshIfAllCompleted()},checkAndRefreshIfAllCompleted:()=>{const{uploading_files:e}=t(),n=be.getState().current_drive_user_id||"";if(!n)return;const r=e.get(n);r&&0!==r.size&&Array.from(r.values()).every(e=>{return"complete"===(t=e.upload_status)||"failed"===t;var t})&&(t().clearUploadingFiles(),t().fetchFileList())},removeUploadingFile:(t,n)=>{t&&e(e=>{const r=n||be.getState().current_drive_user_id||"";if(r){const n=e.uploading_files.get(r);n&&n.delete(t)}})},clearUploadingFiles:t=>{e(e=>{const n=t||be.getState().current_drive_user_id||"";n&&e.uploading_files.delete(n)})},getUploadingFilesForCurrentUser:()=>{const{uploading_files:e}=t(),n=be.getState().current_drive_user_id||"";return n&&e.get(n)||new Map},fetchFileList:async()=>{const{_uploadedFilesController:r,currentPage:s,pageSize:o}=t();r&&r.abort();const i=new AbortController;e(e=>{e._uploadedFilesController=i,e.isLoading=!0,e.file_list=[]});try{const{current_drive_user_id:t}=be.getState(),{user_id:n}=ve.getState(),r={limit:o,offset:(s-1)*o,signal:i.signal};t&&t!==n&&(r.user_id=t);const{files:a,total:c,total_size:l}=await p.getUploadedFiles(r);e(e=>{e.file_list=a.map(e=>({...e,show_file_size:me(e.file_size)})),e.total=c,e.total_size=l,e.isLoading=!1,e._uploadedFilesController=null})}catch(a){if("AbortError"===a.name||"CanceledError"===a.name)return;n.error("ERROR: fetchFileList",a),e(e=>{e.isLoading=!1,e._uploadedFilesController=null})}},setPage:n=>{e(e=>{e.currentPage=n}),t().fetchFileList()},setPageWithoutFetch:t=>{e(e=>{e.currentPage=t})},setPageSize:n=>{e(e=>{e.currentPage=1,e.pageSize=n}),t().fetchFileList()},nextPage:()=>{const{currentPage:n,total:r,pageSize:s}=t(),o=Math.ceil(r/s);n<o&&(e(e=>{e.currentPage=n+1}),t().fetchFileList())},prevPage:()=>{const{currentPage:n}=t();n>1&&(e(e=>{e.currentPage=n-1}),t().fetchFileList())}})))),be=e("a",f((e,t)=>({current_drive_user_id:localStorage.getItem(g)||"",setCurrentDriveUserId:n=>{const r=t().current_drive_user_id;e({current_drive_user_id:n}),r!==n&&n&&(he().getConnection(n),we.getState().clearUploadingFiles())}}))),ve=e("u",f((e,t)=>({_beneficiaryUsersController:null,user_id:localStorage.getItem(g)||"",user_email:localStorage.getItem(b)||"",user_name:localStorage.getItem(w)||"",setUserInfo:t=>{localStorage.setItem(w,t.name||""),localStorage.setItem(b,t.email||""),localStorage.setItem(g,t.user_id||""),e({user_name:t.name||"",user_email:t.email||"",user_id:t.user_id||""}),be.getState().setCurrentDriveUserId(t.user_id||"")},beneficiary_users:[{id:localStorage.getItem(g)||"",name:localStorage.getItem(w)||"",email:localStorage.getItem(b)||"",is_current_user:!0}],setBeneficiaryUsers:t=>{e({beneficiary_users:t})},fetchBeneficiaryUsers:async()=>{const{_beneficiaryUsersController:r}=t();r&&r.abort();const s=new AbortController;e({_beneficiaryUsersController:s});const o=s.signal;try{const n=await p.beneficiaryUsers(o);e({beneficiary_users:n,_beneficiaryUsersController:null});const r=n.find(e=>e.is_current_user);if(r){const{user_id:n}=t();n||(e({user_id:r.id,user_name:r.name}),localStorage.setItem(g,r.id||""),localStorage.setItem(w,r.name||""));const{current_drive_user_id:s}=be.getState();s||be.getState().setCurrentDriveUserId(r.id)}return n}catch(i){if("AbortError"===i.name||"CanceledError"===i.name)return;n.error("ERROR: fetchBeneficiaryUsers",i)}},current_query_user_id:localStorage.getItem(m)||localStorage.getItem(g)||"",current_query_user_name:localStorage.getItem(_)||localStorage.getItem(w)||"",setCurrentQueryUser:({user_id:t,user_name:n})=>{localStorage.setItem(m,t||""),localStorage.setItem(_,n||""),e({current_query_user_id:t||"",current_query_user_name:n||""})},setCurrentQueryUserByUserId:n=>{if(!n)return;const{beneficiary_users:r}=t(),s=r.find(e=>e.id===n);s&&(e({current_query_user_id:s.id||"",current_query_user_name:s.name||""}),localStorage.setItem(m,s.id||""),localStorage.setItem(_,s.name||""))}})))}}});
