import{u as J,a as P,b as K,c as Q,j as t,k as ce,M as oe}from"./index-BICubz86.js";import{H as ie}from"./index-CoRyhR67.js";import{M as de}from"./index-DUhhDYCf.js";import{s as G,T as fe}from"./index-CoJZIexe.js";import{r as n,e as S,f as $,u as ue,I as pe,x as xe,B as H,t as me}from"./vendor-antd-DoyqoZ7x.js";import{a as he}from"./account-CsOayCF-.js";import"./vendor-firebase-D-efta1e.js";import"./logo-DuzqZi6-.js";import"./index-mABjyEMg.js";import"./vendor-monaco-3AoEMSHc.js";const I="HH:mm:ss",Y="YYYY-MM-DD",ge=[{label:"Last 7 Days",value:[S().add(-7,"d").startOf("day"),S().endOf("day")]},{label:"Last 14 Days",value:[S().add(-14,"d").startOf("day"),S().endOf("day")]},{label:"Last 30 Days",value:[S().add(-30,"d").startOf("day"),S().endOf("day")]},{label:"Last 90 Days",value:[S().add(-90,"d").startOf("day"),S().endOf("day")]}],ye=({onFilterChange:a}={})=>{const{t:e}=J(),[p,y]=n.useState([]),[g,E]=n.useState(null),[O,w]=n.useState(!1),[M,x]=n.useState([S().add(-30,"d").startOf("day"),S().endOf("day")]),_=n.useMemo(()=>{p.find(m=>m.scene===g);const l=[];return P.log("filters",l),l},[g,p]);n.useEffect(()=>{(async()=>{w(!0);try{const m=await K.listUserDataScene(),u=Array.isArray(m)?m:[];y(u),u.length>0&&E(u[0].scene)}catch(m){P.error("ERROR: fetchSceneList",m),$.error(e("fetch_scene_list_failed"))}finally{w(!1)}})()},[]);const j=n.useCallback(l=>{E(l),a==null||a()},[a]),L=n.useCallback(l=>{l&&(x(l),a==null||a())},[a]);return{sceneList:p,selectedScene:g,sceneLoading:O,onSceneChange:j,dateRange:M,onDateChange:L,filters:_}},{RangePicker:be}=ue,Se=a=>{const e=Q.c(2),{filter:p}=a;if(p.type==="input"){const y=p.placeholder||"";let g;return e[0]!==y?(g=t.jsx(pe,{type:"text",placeholder:y}),e[0]=y,e[1]=g):g=e[1],g}else return null},we=a=>{const e=Q.c(35),{sceneList:p,selectedScene:y,sceneLoading:g,onSceneChange:E,dateRange:O,onDateChange:w,filters:M}=a,{t:x}=J();let _;e[0]!==x?(_=x("scene"),e[0]=x,e[1]=_):_=e[1];let j;e[2]!==_?(j=t.jsxs("div",{className:"whitespace-nowrap",children:[_,":"]}),e[2]=_,e[3]=j):j=e[3];let L;e[4]===Symbol.for("react.memo_cache_sentinel")?(L={width:200},e[4]=L):L=e[4];let l;e[5]!==x?(l=x("please_select"),e[5]=x,e[6]=l):l=e[6];let m;e[7]!==p?(m=p.map(_e),e[7]=p,e[8]=m):m=e[8];let u;e[9]!==E||e[10]!==g||e[11]!==y||e[12]!==l||e[13]!==m?(u=t.jsx(xe,{style:L,placeholder:l,options:m,onChange:E,value:y,loading:g}),e[9]=E,e[10]=g,e[11]=y,e[12]=l,e[13]=m,e[14]=u):u=e[14];let C;e[15]!==j||e[16]!==u?(C=t.jsxs("div",{className:"flex items-center gap-[16px]",children:[j,u]}),e[15]=j,e[16]=u,e[17]=C):C=e[17];let T;e[18]!==x?(T=x("date_range"),e[18]=x,e[19]=T):T=e[19];let v;e[20]!==T?(v=t.jsxs("div",{className:"whitespace-nowrap",children:[T,":"]}),e[20]=T,e[21]=v):v=e[21];let D;e[22]===Symbol.for("react.memo_cache_sentinel")?(D=[{label:t.jsx("span",{"aria-label":"Current Time to End of Day",children:"Now ~ EOD"}),value:je},...ge],e[22]=D):D=e[22];let k;e[23]!==O||e[24]!==w?(k=t.jsx(be,{presets:D,format:"".concat(Y," ").concat(I),onChange:w,value:O,showTime:!0}),e[23]=O,e[24]=w,e[25]=k):k=e[25];let N;e[26]!==k||e[27]!==v?(N=t.jsxs("div",{className:"flex items-center gap-[16px]",children:[v,k]}),e[26]=k,e[27]=v,e[28]=N):N=e[28];let f;e[29]!==M?(f=M.map(ve),e[29]=M,e[30]=f):f=e[30];let A;return e[31]!==N||e[32]!==f||e[33]!==C?(A=t.jsxs(t.Fragment,{children:[C,N,f]}),e[31]=N,e[32]=f,e[33]=C,e[34]=A):A=e[34],A};function _e(a){return{label:a.scene,value:a.scene}}function je(){return[S(),S().endOf("day")]}function ve(a){return t.jsxs("div",{className:"flex items-center gap-[16px]",children:[t.jsxs("div",{className:"whitespace-nowrap",children:[a.name,":"]}),t.jsx(Se,{filter:a})]},a.id)}const Ae=()=>{const{t:a}=J(),e=ce(),p=he(r=>r.current_drive_user_id),[y,g]=n.useState([]),[E,O]=n.useState(!1),[w,M]=n.useState(1),[x,_]=n.useState(20),[j,L]=n.useState(0),[l,m]=n.useState([]),[u,C]=n.useState([]),[T,v]=n.useState(new Map),D=n.useRef(null),k=n.useCallback(()=>{M(1),m([])},[]),{sceneList:N,selectedScene:f,sceneLoading:A,onSceneChange:X,dateRange:z,onDateChange:Z,filters:F}=ye({onFilterChange:k}),V=n.useMemo(()=>{const r=N.find(s=>s.scene===f);return((r==null?void 0:r.schemas)||[]).map(s=>{var c,i,d,o,b,R;return{id:s.id,accessorKey:s.id,header:s.header,size:s.id==="id"?100:150,meta:{editable:(i=(c=s.meta)==null?void 0:c.editable)!=null?i:!1,sortable:(o=(d=s.meta)==null?void 0:d.sortable)!=null?o:!1,ellipsis:{showTooltip:!0},editor:(R=(b=s.meta)==null?void 0:b.editor)!=null?R:!1}}})},[f,N]),B=n.useCallback(async()=>{if(f){D.current&&D.current.abort(),D.current=new AbortController,O(!0);try{const[r,h]=z,s={scene:f,page:w,page_size:x};r&&h&&(s.start_time=r.format("".concat(Y," ").concat(I)),s.end_time=h.format("".concat(Y," ").concat(I))),l&&Array.isArray(l)&&l.length>0&&(s.order=l),p&&(s.target_user_id=p);const c=await K.searchUserData(s),i=(c.data||[]).map(d=>{const o={...d};for(const b in o){const R=o[b];if(R!==null&&typeof R=="object")try{o[b]=JSON.stringify(R)}catch(U){o[b]=""}}return o});g(i),L(c.total||0),v(d=>{const o=new Map(d),b=new Map;return i.forEach(R=>{b.set(String(R.id),R)}),o.forEach((R,U)=>{const q=b.get(String(U));q&&o.set(String(U),q)}),o})}catch(r){if(r.name==="CanceledError"||r.name==="AbortError")return;P.error("ERROR: fetchTableData",r)}finally{O(!1)}}},[f,z,w,x,l,p]);n.useEffect(()=>{f&&B()},[f,z,w,x,l,B]),n.useEffect(()=>()=>{D.current&&D.current.abort()},[]);const ee=r=>{M(r.current),_(r.pageSize)},te=(r,h)=>{m(s=>{const c=s.findIndex(i=>i.order_key===r);if(h===null)return c>=0?s.filter((i,d)=>d!==c):s;if(c>=0){const i=[...s];return i[c]={order_key:r,order_type:h},i}else return[...s,{order_key:r,order_type:h}]}),M(1)},se=async(r,h)=>{if(!f)return;const s=h==null?void 0:h.dataIndex,c=r[s];if(s)try{await K.updateUserData({scene:f,id:r.id,update_key:s,update_value:c,target_user_id:p}),$.success(a("update_success")),B()}catch(i){P.error("ERROR: updateUserData",i),$.error(a("update_failed"))}},W=n.useCallback(r=>{C(r),v(h=>{const s=new Map(h),c=new Set(r.map(d=>String(d)));h.forEach((d,o)=>{c.has(String(o))||s.delete(String(o))});const i=new Map;return y.forEach(d=>{i.set(String(d.id),d)}),r.forEach(d=>{if(!s.has(String(d))){const o=i.get(String(d));o&&s.set(String(d),o)}}),s})},[y]),ae=n.useMemo(()=>({selectedRowKeys:u,onChange:W}),[u,W]),re=async()=>{if(f)try{await K.deleteUserData({scene:f,ids:u,target_user_id:p}),await B(),C([]),v(new Map),$.success(a("delete_success"))}catch(r){P.error("ERROR: onDeleteSelected",r),$.error(a("delete_failed"))}},ne=async()=>{const r=V.slice(0,4),h=u.map(s=>T.get(String(s))||{id:s}).filter(Boolean);oe.confirm({title:a("delete_selected_indicators"),content:t.jsxs(t.Fragment,{children:[t.jsx("div",{children:a("delete_selected_indicators_content")}),t.jsxs("div",{style:{marginTop:12},children:[t.jsxs("div",{style:{fontWeight:500,marginBottom:8},children:[a("selected_indicators"),":"]}),t.jsx("div",{className:"max-h-[200px] overflow-y-auto overflow-x-auto border border-[#d9d9d9] rounded-[4px] w-full",children:t.jsxs("table",{className:"w-full border-collapse",children:[t.jsx("thead",{children:t.jsx("tr",{className:"bg-[#fafafa] border-b border-[#f0f0f0]",children:r.map((s,c)=>t.jsx("th",{className:"text-left text-[14px] font-[500] text-[rgba(0,0,0,0.85)] px-[12px] py-[4px] border-r border-[#f0f0f0] last:border-r-0",children:s.header||s.id},s.id||c))})}),t.jsx("tbody",{children:h.map((s,c)=>t.jsx("tr",{className:"border-b border-[#f0f0f0] last:border-b-0",children:r.map((i,d)=>{var o,b;return t.jsx("td",{className:"text-[14px] text-[#666] px-[12px] py-[4px] border-r border-[#f0f0f0] last:border-r-0 whitespace-nowrap max-w-[200px] overflow-hidden text-ellipsis",title:(o=s[i.accessorKey])!=null?o:"-",children:(b=s[i.accessorKey])!=null?b:"-"},i.id||d)})},s.id||c))})]})})]})]}),onOk:re,OkButton:({loading:s,onClick:c})=>t.jsx(H,{size:"large",onClick:c,loading:s,style:{height:"36px",backgroundColor:"#EC221F",color:"#fff",border:"none"},children:a("delete")})})},le=u.length>0;return t.jsxs("div",{className:"w-full h-dvh overflow-hidden flex flex-col",children:[t.jsx(ie,{}),t.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[t.jsx(de,{}),t.jsxs("div",{className:"flex flex-col flex-1 overflow-x-auto",children:[t.jsxs("div",{className:"flex items-center justify-between mt-[12px] pl-[24px] pr-[24px]",children:[t.jsx("div",{className:"text-[24px] font-[500] text-[#111827] select-none",children:a("data_property")}),t.jsx(H,{type:"default",icon:t.jsx(me,{}),onClick:()=>e("/indicator"),children:a("switch_to_old_mode")})]}),t.jsx("div",{className:"pl-[24px] pr-[24px] ".concat(G.filterContainer),children:t.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-[16px]",children:[t.jsx("div",{className:"flex items-center gap-[24px] flex-wrap",children:t.jsx(we,{sceneList:N,selectedScene:f,sceneLoading:A,onSceneChange:X,dateRange:z,onDateChange:Z,filters:F})}),t.jsxs("div",{className:"flex items-center gap-[16px]",children:[t.jsxs("span",{className:"text-[14px] text-[#666]",children:[a("selected"),": ",u.length]}),t.jsx(H,{type:"primary",onClick:ne,disabled:!le,children:a("delete")})]})]})}),t.jsx("div",{className:"flex-1 flex flex-col overflow-hidden pr-[24px] pl-[24px]",children:t.jsx(fe,{rowClassName:()=>G.editableRow,data:y,columns:V,loading:E,pagination:{total:j,pageSize:x,current:w},scroll:{x:"max-content",y:"auto"},rowKey:"id",sticky:!0,onChange:ee,bordered:!0,size:"small",rowSelection:ae,handleSave:se,onSortChange:te,sortState:l})})]})]})]})};export{Ae as default};
