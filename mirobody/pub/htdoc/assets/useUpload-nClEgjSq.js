import{a as fe,p as Je,r as I}from"./vendor-antd-DoyqoZ7x.js";import{a as q,A as Ge,v as be}from"./index-BICubz86.js";import{a as ie,b as le,g as He,f as ze}from"./account-CsOayCF-.js";var ne={},w={},ae={},Oe;function A(){return Oe||(Oe=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.isEventSourceSupported=e.isReactNative=e.ReadyState=e.DEFAULT_HEARTBEAT=e.UNPARSABLE_JSON_OBJECT=e.DEFAULT_RECONNECT_INTERVAL_MS=e.DEFAULT_RECONNECT_LIMIT=e.SOCKET_IO_PING_CODE=e.SOCKET_IO_PATH=e.SOCKET_IO_PING_INTERVAL=e.DEFAULT_EVENT_SOURCE_OPTIONS=e.EMPTY_EVENT_HANDLERS=e.DEFAULT_OPTIONS=void 0;var o=1,_=1e3*o;e.DEFAULT_OPTIONS={},e.EMPTY_EVENT_HANDLERS={},e.DEFAULT_EVENT_SOURCE_OPTIONS={withCredentials:!1,events:e.EMPTY_EVENT_HANDLERS},e.SOCKET_IO_PING_INTERVAL=25*_,e.SOCKET_IO_PATH="/socket.io/?EIO=3&transport=websocket",e.SOCKET_IO_PING_CODE="2",e.DEFAULT_RECONNECT_LIMIT=20,e.DEFAULT_RECONNECT_INTERVAL_MS=5e3,e.UNPARSABLE_JSON_OBJECT={},e.DEFAULT_HEARTBEAT={message:"ping",timeout:6e4,interval:25e3};var S;(function(g){g[g.UNINSTANTIATED=-1]="UNINSTANTIATED",g[g.CONNECTING=0]="CONNECTING",g[g.OPEN=1]="OPEN",g[g.CLOSING=2]="CLOSING",g[g.CLOSED=3]="CLOSED"})(S||(e.ReadyState=S={}));var f=function(){try{return"EventSource"in globalThis}catch(g){return!1}};e.isReactNative=typeof navigator<"u"&&navigator.product==="ReactNative",e.isEventSourceSupported=!e.isReactNative&&f()})(ae)),ae}var K={},ce={},me;function de(){return me||(me=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.resetWebSockets=e.sharedWebSockets=void 0,e.sharedWebSockets={};var o=function(_){if(_&&e.sharedWebSockets.hasOwnProperty(_))delete e.sharedWebSockets[_];else for(var S in e.sharedWebSockets)e.sharedWebSockets.hasOwnProperty(S)&&delete e.sharedWebSockets[S]};e.resetWebSockets=o})(ce)),ce}var J={},W={},pe;function ve(){if(pe)return W;pe=1,Object.defineProperty(W,"__esModule",{value:!0}),W.setUpSocketIOPing=W.appendQueryParams=W.parseSocketIOUrl=void 0;var e=A(),o=function(f){if(f){var g=/^https|wss/.test(f),h=f.replace(/^(https?|wss?)(:\/\/)?/,""),y=h.replace(/\/$/,""),s=g?"wss":"ws";return"".concat(s,"://").concat(y).concat(e.SOCKET_IO_PATH)}else if(f===""){var g=/^https/.test(window.location.protocol),s=g?"wss":"ws",l=window.location.port?":".concat(window.location.port):"";return"".concat(s,"://").concat(window.location.hostname).concat(l).concat(e.SOCKET_IO_PATH)}return f};W.parseSocketIOUrl=o;var _=function(f,g){g===void 0&&(g={});var h=/\?([\w]+=[\w]+)/,y=h.test(f),s="".concat(Object.entries(g).reduce(function(l,c){var n=c[0],u=c[1];return l+"".concat(n,"=").concat(u,"&")},"").slice(0,-1));return"".concat(f).concat(y?"&":"?").concat(s)};W.appendQueryParams=_;var S=function(f,g){g===void 0&&(g=e.SOCKET_IO_PING_INTERVAL);var h=function(){return f(e.SOCKET_IO_PING_CODE)};return window.setInterval(h,g)};return W.setUpSocketIOPing=S,W}var x={},Te;function je(){if(Te)return x;Te=1,Object.defineProperty(x,"__esModule",{value:!0}),x.heartbeat=_;var e=A();function o(S){return Array.isArray(S)?S.reduce(function(f,g){return f.current>g.current?f:g}).current:S.current}function _(S,f,g){var h=g||{},y=h.interval,s=y===void 0?e.DEFAULT_HEARTBEAT.interval:y,l=h.timeout,c=l===void 0?e.DEFAULT_HEARTBEAT.timeout:l,n=h.message,u=n===void 0?e.DEFAULT_HEARTBEAT.message:n,t=Math.max(100,s/10),r=Date.now(),i=setInterval(function(){var v=Date.now(),a=o(f);if(a+c<=v)console.warn("Heartbeat timed out, closing connection, last message received ".concat(v-a,"ms ago, last ping sent ").concat(v-r,"ms ago")),S.close();else if(a+s<=v&&r+s<=v)try{typeof u=="function"?S.send(u()):S.send(u),r=v}catch(b){console.error("Heartbeat failed, closing connection",b instanceof Error?b.message:b),S.close()}},t);return S.addEventListener("close",function(){clearInterval(i)}),function(){}}return x}var Q={},ue={},Ne;function Se(){return Ne||(Ne=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.resetSubscribers=e.removeSubscriber=e.addSubscriber=e.hasSubscribers=e.getSubscribers=void 0;var o={},_=[],S=function(s){return(0,e.hasSubscribers)(s)?Array.from(o[s]):_};e.getSubscribers=S;var f=function(s){var l;return((l=o[s])===null||l===void 0?void 0:l.size)>0};e.hasSubscribers=f;var g=function(s,l){o[s]=o[s]||new Set,o[s].add(l)};e.addSubscriber=g;var h=function(s,l){o[s].delete(l)};e.removeSubscriber=h;var y=function(s){if(s&&o.hasOwnProperty(s))delete o[s];else for(var l in o)o.hasOwnProperty(l)&&delete o[l]};e.resetSubscribers=y})(ue)),ue}var Ce;function _e(){if(Ce)return Q;Ce=1,Object.defineProperty(Q,"__esModule",{value:!0}),Q.assertIsWebSocket=_,Q.resetGlobalState=S;var e=de(),o=Se();function _(f,g){if(!g&&!(f instanceof WebSocket))throw new Error("")}function S(f){(0,o.resetSubscribers)(f),(0,e.resetWebSockets)(f)}return Q}var Ie;function Ve(){if(Ie)return J;Ie=1;var e=J&&J.__assign||function(){return e=Object.assign||function(c){for(var n,u=1,t=arguments.length;u<t;u++){n=arguments[u];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(c[r]=n[r])}return c},e.apply(this,arguments)};Object.defineProperty(J,"__esModule",{value:!0}),J.attachListeners=void 0;var o=ve(),_=je(),S=A(),f=_e(),g=function(c,n,u,t){c.onmessage=function(r){var i;n.current.onMessage&&n.current.onMessage(r),typeof(t==null?void 0:t.current)=="number"&&(t.current=Date.now()),!(typeof n.current.filter=="function"&&n.current.filter(r)!==!0)&&(n.current.heartbeat&&typeof n.current.heartbeat!="boolean"&&((i=n.current.heartbeat)===null||i===void 0?void 0:i.returnMessage)===r.data||u(r))}},h=function(c,n,u,t,r){c.onopen=function(i){if(n.current.onOpen&&n.current.onOpen(i),t.current=0,u(S.ReadyState.OPEN),n.current.heartbeat&&c instanceof WebSocket){var v=typeof n.current.heartbeat=="boolean"?void 0:n.current.heartbeat;r.current=Date.now(),(0,_.heartbeat)(c,r,v)}}},y=function(c,n,u,t,r){if(S.isEventSourceSupported&&c instanceof EventSource)return function(){};(0,f.assertIsWebSocket)(c,n.current.skipAssert);var i;return c.onclose=function(v){var a;if(n.current.onClose&&n.current.onClose(v),u(S.ReadyState.CLOSED),n.current.shouldReconnect&&n.current.shouldReconnect(v)){var b=(a=n.current.reconnectAttempts)!==null&&a!==void 0?a:S.DEFAULT_RECONNECT_LIMIT;if(r.current<b){var p=typeof n.current.reconnectInterval=="function"?n.current.reconnectInterval(r.current):n.current.reconnectInterval;i=window.setTimeout(function(){r.current++,t()},p!=null?p:S.DEFAULT_RECONNECT_INTERVAL_MS)}else n.current.onReconnectStop&&n.current.onReconnectStop(b),console.warn("Max reconnect attempts of ".concat(b," exceeded"))}},function(){return i&&window.clearTimeout(i)}},s=function(c,n,u,t,r){var i;return c.onerror=function(v){var a;if(n.current.onError&&n.current.onError(v),S.isEventSourceSupported&&c instanceof EventSource&&(n.current.onClose&&n.current.onClose(e(e({},v),{code:1006,reason:"An error occurred with the EventSource: ".concat(v),wasClean:!1})),u(S.ReadyState.CLOSED),c.close()),n.current.retryOnError)if(r.current<((a=n.current.reconnectAttempts)!==null&&a!==void 0?a:S.DEFAULT_RECONNECT_LIMIT)){var b=typeof n.current.reconnectInterval=="function"?n.current.reconnectInterval(r.current):n.current.reconnectInterval;i=window.setTimeout(function(){r.current++,t()},b!=null?b:S.DEFAULT_RECONNECT_INTERVAL_MS)}else n.current.onReconnectStop&&n.current.onReconnectStop(n.current.reconnectAttempts),console.warn("Max reconnect attempts of ".concat(n.current.reconnectAttempts," exceeded"))},function(){return i&&window.clearTimeout(i)}},l=function(c,n,u,t,r,i,v){var a=n.setLastMessage,b=n.setReadyState,p,E,d;return u.current.fromSocketIO&&(p=(0,o.setUpSocketIOPing)(v)),g(c,u,a,i),h(c,u,b,r,i),E=y(c,u,b,t,r),d=s(c,u,b,t,r),function(){b(S.ReadyState.CLOSING),E(),d(),c.close(),p&&clearInterval(p)}};return J.attachListeners=l,J}var G={},we;function Be(){if(we)return G;we=1;var e=G&&G.__assign||function(){return e=Object.assign||function(n){for(var u,t=1,r=arguments.length;t<r;t++){u=arguments[t];for(var i in u)Object.prototype.hasOwnProperty.call(u,i)&&(n[i]=u[i])}return n},e.apply(this,arguments)};Object.defineProperty(G,"__esModule",{value:!0}),G.attachSharedListeners=void 0;var o=de(),_=A(),S=Se(),f=ve(),g=je(),h=function(n,u,t){n.onmessage=function(r){(0,S.getSubscribers)(u).forEach(function(i){var v;i.optionsRef.current.onMessage&&i.optionsRef.current.onMessage(r),typeof((v=i==null?void 0:i.lastMessageTime)===null||v===void 0?void 0:v.current)=="number"&&(i.lastMessageTime.current=Date.now()),!(typeof i.optionsRef.current.filter=="function"&&i.optionsRef.current.filter(r)!==!0)&&(t&&typeof t!="boolean"&&(t==null?void 0:t.returnMessage)===r.data||i.setLastMessage(r))})}},y=function(n,u,t){n.onopen=function(r){var i=(0,S.getSubscribers)(u);i.forEach(function(v){v.reconnectCount.current=0,v.optionsRef.current.onOpen&&v.optionsRef.current.onOpen(r),v.setReadyState(_.ReadyState.OPEN),t&&n instanceof WebSocket&&(v.lastMessageTime.current=Date.now())}),t&&n instanceof WebSocket&&(0,g.heartbeat)(n,i.map(function(v){return v.lastMessageTime}),typeof t=="boolean"?void 0:t)}},s=function(n,u){n instanceof WebSocket&&(n.onclose=function(t){(0,S.getSubscribers)(u).forEach(function(r){r.optionsRef.current.onClose&&r.optionsRef.current.onClose(t),r.setReadyState(_.ReadyState.CLOSED)}),delete o.sharedWebSockets[u],(0,S.getSubscribers)(u).forEach(function(r){var i;if(r.optionsRef.current.shouldReconnect&&r.optionsRef.current.shouldReconnect(t)){var v=(i=r.optionsRef.current.reconnectAttempts)!==null&&i!==void 0?i:_.DEFAULT_RECONNECT_LIMIT;if(r.reconnectCount.current<v){var a=typeof r.optionsRef.current.reconnectInterval=="function"?r.optionsRef.current.reconnectInterval(r.reconnectCount.current):r.optionsRef.current.reconnectInterval;setTimeout(function(){r.reconnectCount.current++,r.reconnect.current()},a!=null?a:_.DEFAULT_RECONNECT_INTERVAL_MS)}else r.optionsRef.current.onReconnectStop&&r.optionsRef.current.onReconnectStop(r.optionsRef.current.reconnectAttempts),console.warn("Max reconnect attempts of ".concat(v," exceeded"))}})})},l=function(n,u){n.onerror=function(t){(0,S.getSubscribers)(u).forEach(function(r){r.optionsRef.current.onError&&r.optionsRef.current.onError(t),_.isEventSourceSupported&&n instanceof EventSource&&(r.optionsRef.current.onClose&&r.optionsRef.current.onClose(e(e({},t),{code:1006,reason:"An error occurred with the EventSource: ".concat(t),wasClean:!1})),r.setReadyState(_.ReadyState.CLOSED))}),_.isEventSourceSupported&&n instanceof EventSource&&n.close()}},c=function(n,u,t,r){var i;return t.current.fromSocketIO&&(i=(0,f.setUpSocketIOPing)(r)),h(n,u,t.current.heartbeat),s(n,u),y(n,u,t.current.heartbeat),l(n,u),function(){i&&clearInterval(i)}};return G.attachSharedListeners=c,G}var ke;function Ke(){if(ke)return K;ke=1,Object.defineProperty(K,"__esModule",{value:!0}),K.createOrJoinSocket=void 0;var e=de(),o=A(),_=Ve(),S=Be(),f=Se(),g=function(y,s,l,c,n){return function(){if((0,f.removeSubscriber)(y,s),!(0,f.hasSubscribers)(y)){try{var u=e.sharedWebSockets[y];u instanceof WebSocket&&(u.onclose=function(t){l.current.onClose&&l.current.onClose(t),c(o.ReadyState.CLOSED)}),u.close()}catch(t){}n&&n(),delete e.sharedWebSockets[y]}}},h=function(y,s,l,c,n,u,t,r,i){if(!o.isEventSourceSupported&&c.current.eventSourceOptions)throw o.isReactNative?new Error("EventSource is not supported in ReactNative"):new Error("EventSource is not supported");if(c.current.share){var v=null;e.sharedWebSockets[s]===void 0?(e.sharedWebSockets[s]=c.current.eventSourceOptions?new EventSource(s,c.current.eventSourceOptions):new WebSocket(s,c.current.protocols),y.current=e.sharedWebSockets[s],l(o.ReadyState.CONNECTING),v=(0,S.attachSharedListeners)(e.sharedWebSockets[s],s,c,i)):(y.current=e.sharedWebSockets[s],l(e.sharedWebSockets[s].readyState));var a={setLastMessage:n,setReadyState:l,optionsRef:c,reconnectCount:t,lastMessageTime:r,reconnect:u};return(0,f.addSubscriber)(s,a),g(s,a,c,l,v)}else{if(y.current=c.current.eventSourceOptions?new EventSource(s,c.current.eventSourceOptions):new WebSocket(s,c.current.protocols),l(o.ReadyState.CONNECTING),!y.current)throw new Error("WebSocket failed to be created");return(0,_.attachListeners)(y.current,{setLastMessage:n,setReadyState:l},c,u.current,t,r,i)}};return K.createOrJoinSocket=h,K}var D={},Ue;function Qe(){return Ue||(Ue=1,(function(e){var o=D&&D.__awaiter||function(s,l,c,n){function u(t){return t instanceof c?t:new c(function(r){r(t)})}return new(c||(c=Promise))(function(t,r){function i(b){try{a(n.next(b))}catch(p){r(p)}}function v(b){try{a(n.throw(b))}catch(p){r(p)}}function a(b){b.done?t(b.value):u(b.value).then(i,v)}a((n=n.apply(s,l||[])).next())})},_=D&&D.__generator||function(s,l){var c={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},n,u,t,r=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return r.next=i(0),r.throw=i(1),r.return=i(2),typeof Symbol=="function"&&(r[Symbol.iterator]=function(){return this}),r;function i(a){return function(b){return v([a,b])}}function v(a){if(n)throw new TypeError("Generator is already executing.");for(;r&&(r=0,a[0]&&(c=0)),c;)try{if(n=1,u&&(t=a[0]&2?u.return:a[0]?u.throw||((t=u.return)&&t.call(u),0):u.next)&&!(t=t.call(u,a[1])).done)return t;switch(u=0,t&&(a=[a[0]&2,t.value]),a[0]){case 0:case 1:t=a;break;case 4:return c.label++,{value:a[1],done:!1};case 5:c.label++,u=a[1],a=[0];continue;case 7:a=c.ops.pop(),c.trys.pop();continue;default:if(t=c.trys,!(t=t.length>0&&t[t.length-1])&&(a[0]===6||a[0]===2)){c=0;continue}if(a[0]===3&&(!t||a[1]>t[0]&&a[1]<t[3])){c.label=a[1];break}if(a[0]===6&&c.label<t[1]){c.label=t[1],t=a;break}if(t&&c.label<t[2]){c.label=t[2],c.ops.push(a);break}t[2]&&c.ops.pop(),c.trys.pop();continue}a=l.call(s,c)}catch(b){a=[6,b],u=0}finally{n=t=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}},S=D&&D.__spreadArray||function(s,l,c){if(c||arguments.length===2)for(var n=0,u=l.length,t;n<u;n++)(t||!(n in l))&&(t||(t=Array.prototype.slice.call(l,0,n)),t[n]=l[n]);return s.concat(t||Array.prototype.slice.call(l))};Object.defineProperty(e,"__esModule",{value:!0}),e.getUrl=void 0;var f=ve(),g=A(),h=function(s){return new Promise(function(l){return window.setTimeout(l,s)})},y=function(s,l){for(var c=[],n=2;n<arguments.length;n++)c[n-2]=arguments[n];return o(void 0,S([s,l],c,!0),void 0,function(u,t,r){var i,v,a,b,p,E,d,O;return r===void 0&&(r=0),_(this,function(m){switch(m.label){case 0:if(typeof u!="function")return[3,10];m.label=1;case 1:return m.trys.push([1,3,,9]),[4,u()];case 2:return i=m.sent(),[3,9];case 3:return m.sent(),t.current.retryOnError?(v=(E=t.current.reconnectAttempts)!==null&&E!==void 0?E:g.DEFAULT_RECONNECT_LIMIT,r<v?(a=typeof t.current.reconnectInterval=="function"?t.current.reconnectInterval(r):t.current.reconnectInterval,[4,h(a!=null?a:g.DEFAULT_RECONNECT_INTERVAL_MS)]):[3,5]):[3,7];case 4:return m.sent(),[2,(0,e.getUrl)(u,t,r+1)];case 5:return(O=(d=t.current).onReconnectStop)===null||O===void 0||O.call(d,r),[2,null];case 6:return[3,8];case 7:return[2,null];case 8:return[3,9];case 9:return[3,11];case 10:i=u,m.label=11;case 11:return b=t.current.fromSocketIO?(0,f.parseSocketIOUrl)(i):i,p=t.current.queryParams?(0,f.appendQueryParams)(b,t.current.queryParams):b,[2,p]}})})};e.getUrl=y})(D)),D}var oe={},Me;function Ye(){return Me||(Me=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.websocketWrapper=void 0;var o=function(_,S){return new Proxy(_,{get:function(f,g){var h=f[g];return g==="reconnect"?S:typeof h=="function"?(console.error("Calling methods directly on the websocket is not supported at this moment. You must use the methods returned by useWebSocket."),function(){}):h},set:function(f,g,h){return/^on/.test(g)?(console.warn("The websocket's event handlers should be defined through the options object passed into useWebSocket."),!1):(f[g]=h,!0)}})};e.websocketWrapper=o,e.default=e.websocketWrapper})(oe)),oe}var Le;function ge(){if(Le)return w;Le=1;var e=w&&w.__assign||function(){return e=Object.assign||function(u){for(var t,r=1,i=arguments.length;r<i;r++){t=arguments[r];for(var v in t)Object.prototype.hasOwnProperty.call(t,v)&&(u[v]=t[v])}return u},e.apply(this,arguments)},o=w&&w.__awaiter||function(u,t,r,i){function v(a){return a instanceof r?a:new r(function(b){b(a)})}return new(r||(r=Promise))(function(a,b){function p(O){try{d(i.next(O))}catch(m){b(m)}}function E(O){try{d(i.throw(O))}catch(m){b(m)}}function d(O){O.done?a(O.value):v(O.value).then(p,E)}d((i=i.apply(u,t||[])).next())})},_=w&&w.__generator||function(u,t){var r={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},i,v,a,b=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return b.next=p(0),b.throw=p(1),b.return=p(2),typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function p(d){return function(O){return E([d,O])}}function E(d){if(i)throw new TypeError("Generator is already executing.");for(;b&&(b=0,d[0]&&(r=0)),r;)try{if(i=1,v&&(a=d[0]&2?v.return:d[0]?v.throw||((a=v.return)&&a.call(v),0):v.next)&&!(a=a.call(v,d[1])).done)return a;switch(v=0,a&&(d=[d[0]&2,a.value]),d[0]){case 0:case 1:a=d;break;case 4:return r.label++,{value:d[1],done:!1};case 5:r.label++,v=d[1],d=[0];continue;case 7:d=r.ops.pop(),r.trys.pop();continue;default:if(a=r.trys,!(a=a.length>0&&a[a.length-1])&&(d[0]===6||d[0]===2)){r=0;continue}if(d[0]===3&&(!a||d[1]>a[0]&&d[1]<a[3])){r.label=d[1];break}if(d[0]===6&&r.label<a[1]){r.label=a[1],a=d;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(d);break}a[2]&&r.ops.pop(),r.trys.pop();continue}d=t.call(u,r)}catch(O){d=[6,O],v=0}finally{i=a=0}if(d[0]&5)throw d[1];return{value:d[0]?d[1]:void 0,done:!0}}},S=w&&w.__importDefault||function(u){return u&&u.__esModule?u:{default:u}};Object.defineProperty(w,"__esModule",{value:!0}),w.useWebSocket=void 0;var f=fe(),g=Je(),h=A(),y=Ke(),s=Qe(),l=S(Ye()),c=_e(),n=function(u,t,r){t===void 0&&(t=h.DEFAULT_OPTIONS),r===void 0&&(r=!0);var i=(0,f.useState)(null),v=i[0],a=i[1],b=(0,f.useState)({}),p=b[0],E=b[1],d=(0,f.useMemo)(function(){if(!t.disableJson&&v)try{return JSON.parse(v.data)}catch(C){return h.UNPARSABLE_JSON_OBJECT}return null},[v,t.disableJson]),O=(0,f.useRef)(null),m=(0,f.useRef)(null),N=(0,f.useRef)(function(){}),M=(0,f.useRef)(0),T=(0,f.useRef)(Date.now()),U=(0,f.useRef)([]),P=(0,f.useRef)(null),R=(0,f.useRef)(t);R.current=t;var L=O.current&&p[O.current]!==void 0?p[O.current]:u!==null&&r===!0?h.ReadyState.CONNECTING:h.ReadyState.UNINSTANTIATED,Z=t.queryParams?JSON.stringify(t.queryParams):null,F=(0,f.useCallback)(function(C,k){var z;if(k===void 0&&(k=!0),h.isEventSourceSupported&&m.current instanceof EventSource){console.warn("Unable to send a message from an eventSource");return}((z=m.current)===null||z===void 0?void 0:z.readyState)===h.ReadyState.OPEN?((0,c.assertIsWebSocket)(m.current,R.current.skipAssert),m.current.send(C)):k&&U.current.push(C)},[]),re=(0,f.useCallback)(function(C,k){k===void 0&&(k=!0),F(JSON.stringify(C),k)},[F]),Fe=(0,f.useCallback)(function(){return R.current.share!==!0||h.isEventSourceSupported&&m.current instanceof EventSource?m.current:(P.current===null&&m.current&&((0,c.assertIsWebSocket)(m.current,R.current.skipAssert),P.current=(0,l.default)(m.current,N)),P.current)},[]);return(0,f.useEffect)(function(){if(u!==null&&r===!0){var C,k=!1,z=!0,he=function(){return o(void 0,void 0,void 0,function(){var X,V,Ee;return _(this,function(ye){switch(ye.label){case 0:return X=O,[4,(0,s.getUrl)(u,R)];case 1:return X.current=ye.sent(),O.current===null?(console.error("Failed to get a valid URL. WebSocket connection aborted."),O.current="ABORTED",(0,g.flushSync)(function(){return E(function(B){return e(e({},B),{ABORTED:h.ReadyState.CLOSED})})}),[2]):(V=function(B){k||(0,g.flushSync)(function(){return a(B)})},Ee=function(B){k||(0,g.flushSync)(function(){return E(function(qe){var te;return e(e({},qe),O.current&&(te={},te[O.current]=B,te))})})},z&&(C=(0,y.createOrJoinSocket)(m,O.current,Ee,R,V,N,M,T,F)),[2])}})})};return N.current=function(){k||(P.current&&(P.current=null),C==null||C(),he())},he(),function(){k=!0,z=!1,P.current&&(P.current=null),C==null||C(),a(null)}}else(u===null||r===!1)&&(M.current=0,E(function(X){var V;return e(e({},X),O.current&&(V={},V[O.current]=h.ReadyState.CLOSED,V))}))},[u,r,Z,F]),(0,f.useEffect)(function(){L===h.ReadyState.OPEN&&U.current.splice(0).forEach(function(C){F(C)})},[L]),{sendMessage:F,sendJsonMessage:re,lastMessage:v,lastJsonMessage:d,readyState:L,getWebSocket:Fe}};return w.useWebSocket=n,w}var H={},Ae;function $e(){if(Ae)return H;Ae=1;var e=H&&H.__assign||function(){return e=Object.assign||function(y){for(var s,l=1,c=arguments.length;l<c;l++){s=arguments[l];for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(y[n]=s[n])}return y},e.apply(this,arguments)};Object.defineProperty(H,"__esModule",{value:!0}),H.useSocketIO=void 0;var o=fe(),_=ge(),S=A(),f={type:"empty",payload:null},g=function(y){if(!y||!y.data)return f;var s=y.data.match(/\[.*]/);if(!s)return f;var l=JSON.parse(s);return!Array.isArray(l)||!l[1]?f:{type:l[0],payload:l[1]}},h=function(y,s,l){s===void 0&&(s=S.DEFAULT_OPTIONS),l===void 0&&(l=!0);var c=(0,o.useMemo)(function(){return e(e({},s),{fromSocketIO:!0})},[]),n=(0,_.useWebSocket)(y,c,l),u=n.sendMessage,t=n.sendJsonMessage,r=n.lastMessage,i=n.readyState,v=n.getWebSocket,a=(0,o.useMemo)(function(){return g(r)},[r]);return{sendMessage:u,sendJsonMessage:t,lastMessage:a,lastJsonMessage:a,readyState:i,getWebSocket:v}};return H.useSocketIO=h,H}var j={},Pe;function Ze(){if(Pe)return j;Pe=1;var e=j&&j.__assign||function(){return e=Object.assign||function(h){for(var y,s=1,l=arguments.length;s<l;s++){y=arguments[s];for(var c in y)Object.prototype.hasOwnProperty.call(y,c)&&(h[c]=y[c])}return h},e.apply(this,arguments)},o=j&&j.__rest||function(h,y){var s={};for(var l in h)Object.prototype.hasOwnProperty.call(h,l)&&y.indexOf(l)<0&&(s[l]=h[l]);if(h!=null&&typeof Object.getOwnPropertySymbols=="function")for(var c=0,l=Object.getOwnPropertySymbols(h);c<l.length;c++)y.indexOf(l[c])<0&&Object.prototype.propertyIsEnumerable.call(h,l[c])&&(s[l[c]]=h[l[c]]);return s};Object.defineProperty(j,"__esModule",{value:!0}),j.useEventSource=void 0;var _=fe(),S=ge(),f=A(),g=function(h,y,s){y===void 0&&(y=f.DEFAULT_EVENT_SOURCE_OPTIONS);var l=y.withCredentials,c=y.events,n=o(y,["withCredentials","events"]);s===void 0&&(s=!0);var u=e(e({},n),{eventSourceOptions:{withCredentials:l}}),t=(0,_.useRef)(f.EMPTY_EVENT_HANDLERS);c&&(t.current=c);var r=(0,S.useWebSocket)(h,u,s),i=r.lastMessage,v=r.readyState,a=r.getWebSocket;return(0,_.useEffect)(function(){i!=null&&i.type&&Object.entries(t.current).forEach(function(b){var p=b[0],E=b[1];p===i.type&&E(i)})},[i]),{lastEvent:i,readyState:v,getEventSource:a}};return j.useEventSource=g,j}var Re;function Xe(){return Re||(Re=1,(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.resetGlobalState=e.useEventSource=e.ReadyState=e.useSocketIO=e.default=void 0;var o=ge();Object.defineProperty(e,"default",{enumerable:!0,get:function(){return o.useWebSocket}});var _=$e();Object.defineProperty(e,"useSocketIO",{enumerable:!0,get:function(){return _.useSocketIO}});var S=A();Object.defineProperty(e,"ReadyState",{enumerable:!0,get:function(){return S.ReadyState}});var f=Ze();Object.defineProperty(e,"useEventSource",{enumerable:!0,get:function(){return f.useEventSource}});var g=_e();Object.defineProperty(e,"resetGlobalState",{enumerable:!0,get:function(){return g.resetGlobalState}})})(ne)),ne}var Y=Xe();const $=()=>ie.getState().current_drive_user_id||"",xe=e=>{if(e.files&&e.files.length>0){const o=e.files[0];return{file_name:o.filename,file_size:o.size,file_type:o.contentType}}return e.filename?{file_name:e.filename,file_size:e.size||0,file_type:e.contentType||""}:null},er=(e,o)=>(le.getState().uploading_files.get(o)||new Map).has(e),rr=({status:e,progress:o,message:_})=>e==="completed"?{progress:100,status:"complete",message:_||"Upload completed"}:e==="failed"?{progress:o||0,status:"failed",message:_||"Upload failed"}:{progress:o||0,status:e||"uploading",message:_||""},We=(e,{addUploadingFile:o})=>{const{messageId:_}=e;if(!_)return;const S=$();if(er(_,S))return;const f=xe(e);f&&o(_,f,S)},De=(e,{updateUploadingProgress:o})=>{const{messageId:_,progress:S,status:f,message:g}=e;if(!_)return;const h=$(),y=rr({status:f,progress:S,message:g});o(_,y.progress,y.status,y.message,h)},tr=(e,{updateUploadingProgress:o})=>{const{messageId:_,progress:S,status:f,message:g}=e;if(!_)return;const h=$();o(_,S||100,f||"received",g||"",h)},nr=(e,{updateUploadingProgress:o})=>{const{messageId:_,message:S}=e;if(!_)return;const f=$();o(_,100,"complete",S||"Upload completed",f)},ar=(e,{updateUploadingProgress:o})=>{const{messageId:_,progress:S,message:f}=e;if(!_)return;const g=$();o(_,S||0,"failed",f||"Upload failed",g)},cr=e=>{q.error("useUpload:: WebSocket error message",e)},se=()=>{},ur=e=>({connection_established:se,pong:se,upload_start:o=>We(o,e),upload_start_confirmed:o=>We(o,e),upload_end_response:se,upload_progress:o=>De(o,e),file_progress:o=>De(o,e),file_received:o=>tr(o,e),upload_completed:o=>nr(o,e),upload_error:o=>ar(o,e),error:cr}),or=(e,o)=>{const{type:_}=e,S=o[_];return S?(S(e),!0):(_&&q.debug("useUpload:: Unhandled message type:",_),!1)},ee=5*1024*1024,fr=()=>{const e=le(E=>E.updateUploadingProgress),o=le(E=>E.addUploadingFile),[_,S]=I.useState(null),[f,g]=I.useState(null),h=I.useRef(null),y=I.useCallback(E=>E&&(E.includes("401")||E.includes("Unauthorized")||E.includes("Token expired")||E.includes("Authentication failed")||E.toLowerCase().includes("token")&&E.toLowerCase().includes("invalid"))?(localStorage.removeItem(Ge),window.location.href="/login?redirect=".concat(encodeURIComponent(window.location.pathname)),!0):!1,[]),s=I.useCallback((E,d,O)=>{const m=ie.getState().current_drive_user_id||"";if(!(O&&O!==m)){if(E==="error")q.error("useUpload:: handleWebSocketEvent:: error",d);else if(E==="message"&&d){const N={data:JSON.stringify(d)};S(N),g(d)}}},[]),l=I.useCallback(()=>(h.current||(h.current=He()),h.current),[]);I.useEffect(()=>{const E=l();return E.addListener(s),()=>{E&&E.removeListener(s)}},[s,l]);const c=I.useCallback(E=>l().sendMessage(E),[l]),n=I.useMemo(()=>ur({addUploadingFile:o,updateUploadingProgress:e}),[o,e]);I.useEffect(()=>{if(!(!_||!f))try{if(y(f.message))return;or(f,n)}catch(E){q.error("useUpload::WebSocket message processing error",E)}},[_,f,y,n]);const u=E=>new Promise((d,O)=>{const m=new FileReader;m.onload=()=>d(m.result.split(",")[1]),m.onerror=O,m.readAsDataURL(E)}),t=(E,d,O)=>new Promise((m,N)=>{const M=E.slice(d,O),T=new FileReader;T.onload=()=>m(T.result.split(",")[1]),T.onerror=N,T.readAsDataURL(M)}),r=I.useCallback(async(E,d={})=>{const O=l();h.current||(h.current=O,O.addListener(s));try{await O.ensureConnected()}catch(T){return q.error("useUpload:: startUpload:: Failed to ensure connection:",T),{error:"网络连接失败，请刷新页面重试"}}const m=d.sessionId||be(),N=[],M=ie.getState().current_drive_user_id||"";M||q.error("useUpload::startUpload - No current_drive_user_id, cannot add files to uploading_files");for(const T of E)try{const U=d.messageId||be();N.push(U),M&&o(U,{file_name:T.name,file_size:T.size,file_type:T.type},M);const P={type:"upload_start",messageId:U,sessionId:m,query:d.query||"",isFirstMessage:d.isFirstMessage||!1,files:[{filename:T.name,contentType:T.type,size:T.size}],query_user_id:d.query_user_id||"",...d.metadata&&{metadata:d.metadata}};c(JSON.stringify(P));const R=Math.ceil(T.size/ee);if(T.size<=ee){const L=await u(T);c(JSON.stringify({type:"upload_chunk",messageId:U,filename:T.name,contentType:T.type,chunk:L,chunkIndex:0,totalChunks:1,fileSize:T.size}))}else for(let L=0;L<R;L++){const Z=L*ee,F=Math.min(Z+ee,T.size),re=await t(T,Z,F);c(JSON.stringify({type:"upload_chunk",messageId:U,filename:T.name,contentType:T.type,chunk:re,chunkIndex:L,totalChunks:R,fileSize:T.size}))}c(JSON.stringify({type:"upload_end",messageId:U,sessionId:m}))}catch(U){return q.error("ERROR: startUpload",U),null}return N},[c,l,s,o]),i=I.useCallback(async(E,d={})=>{try{const O=E.map(N=>N.file),m=await r(O,d);return m&&m.length===E.length&&E.forEach((N,M)=>{o(m[M],{...N,show_file_size:ze(N.file_size)})}),m}catch(O){return q.error("ERROR:: uploadFiles::",O),null}},[r,o]),v=I.useCallback(E=>{c(JSON.stringify({type:"get_status",messageId:E}))},[c]),a=()=>{if(!h.current)return Y.ReadyState.CLOSED;const d=h.current.getReadyState();return d===WebSocket.CONNECTING?Y.ReadyState.CONNECTING:d===WebSocket.OPEN?Y.ReadyState.OPEN:d===WebSocket.CLOSING?Y.ReadyState.CLOSING:Y.ReadyState.CLOSED},b=()=>{var E,d;return(d=(E=h.current)==null?void 0:E.isConnected())!=null?d:!1},p=()=>{var E,d;return(d=(E=h.current)==null?void 0:E.isConnecting())!=null?d:!1};return{sendMessage:c,lastMessage:_,readyState:a(),uploadFiles:i,startUpload:r,getUploadStatus:v,isConnected:b(),isConnecting:p()}};export{fr as u};
