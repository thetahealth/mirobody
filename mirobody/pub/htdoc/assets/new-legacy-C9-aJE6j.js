System.register(["./index-legacy-BCYsgP_m.js","./index-legacy-xiHj4BPv.js","./index-legacy-COjwk9rd.js","./index-legacy-CtjrcoBn.js","./vendor-antd-legacy-B_nlExEM.js","./account-legacy-4gI0f2zM.js","./vendor-firebase-legacy-SmJg7pDS.js","./logo-legacy-Dj_BY5C3.js","./index-legacy-BGOD2yAB.js","./vendor-monaco-legacy-DGc0n2EJ.js"],function(e,t){"use strict";var a,s,r,n,l,c,d,i,o,f,x,u,p,h,g,m,y,j,b,w;return{setters:[e=>{a=e.u,s=e.a,r=e.b,n=e.c,l=e.j,c=e.k,d=e.M},e=>{i=e.H},e=>{o=e.M},e=>{f=e.s,x=e.T},e=>{u=e.r,p=e.e,h=e.f,g=e.u,m=e.I,y=e.x,j=e.B,b=e.t},e=>{w=e.a},null,null,null,null],execute:function(){const t="HH:mm:ss",S="YYYY-MM-DD",v=[{label:"Last 7 Days",value:[p().add(-7,"d").startOf("day"),p().endOf("day")]},{label:"Last 14 Days",value:[p().add(-14,"d").startOf("day"),p().endOf("day")]},{label:"Last 30 Days",value:[p().add(-30,"d").startOf("day"),p().endOf("day")]},{label:"Last 90 Days",value:[p().add(-90,"d").startOf("day"),p().endOf("day")]}],{RangePicker:_}=g,C=e=>{const t=n.c(2),{filter:a}=e;if("input"===a.type){const e=a.placeholder||"";let s;return t[0]!==e?(s=l.jsx(m,{type:"text",placeholder:e}),t[0]=e,t[1]=s):s=t[1],s}return null},N=e=>{const s=n.c(35),{sceneList:r,selectedScene:c,sceneLoading:d,onSceneChange:i,dateRange:o,onDateChange:f,filters:x}=e,{t:u}=a();let p,h,g,m,j,b,w,C,N,O,E,L,M,$;return s[0]!==u?(p=u("scene"),s[0]=u,s[1]=p):p=s[1],s[2]!==p?(h=l.jsxs("div",{className:"whitespace-nowrap",children:[p,":"]}),s[2]=p,s[3]=h):h=s[3],s[4]===Symbol.for("react.memo_cache_sentinel")?(g={width:200},s[4]=g):g=s[4],s[5]!==u?(m=u("please_select"),s[5]=u,s[6]=m):m=s[6],s[7]!==r?(j=r.map(k),s[7]=r,s[8]=j):j=s[8],s[9]!==i||s[10]!==d||s[11]!==c||s[12]!==m||s[13]!==j?(b=l.jsx(y,{style:g,placeholder:m,options:j,onChange:i,value:c,loading:d}),s[9]=i,s[10]=d,s[11]=c,s[12]=m,s[13]=j,s[14]=b):b=s[14],s[15]!==h||s[16]!==b?(w=l.jsxs("div",{className:"flex items-center gap-[16px]",children:[h,b]}),s[15]=h,s[16]=b,s[17]=w):w=s[17],s[18]!==u?(C=u("date_range"),s[18]=u,s[19]=C):C=s[19],s[20]!==C?(N=l.jsxs("div",{className:"whitespace-nowrap",children:[C,":"]}),s[20]=C,s[21]=N):N=s[21],s[22]===Symbol.for("react.memo_cache_sentinel")?(O=[{label:l.jsx("span",{"aria-label":"Current Time to End of Day",children:"Now ~ EOD"}),value:R},...v],s[22]=O):O=s[22],s[23]!==o||s[24]!==f?(E=l.jsx(_,{presets:O,format:`${S} ${t}`,onChange:f,value:o,showTime:!0}),s[23]=o,s[24]=f,s[25]=E):E=s[25],s[26]!==E||s[27]!==N?(L=l.jsxs("div",{className:"flex items-center gap-[16px]",children:[N,E]}),s[26]=E,s[27]=N,s[28]=L):L=s[28],s[29]!==x?(M=x.map(D),s[29]=x,s[30]=M):M=s[30],s[31]!==L||s[32]!==M||s[33]!==w?($=l.jsxs(l.Fragment,{children:[w,L,M]}),s[31]=L,s[32]=M,s[33]=w,s[34]=$):$=s[34],$};function k(e){return{label:e.scene,value:e.scene}}function R(){return[p(),p().endOf("day")]}function D(e){return l.jsxs("div",{className:"flex items-center gap-[16px]",children:[l.jsxs("div",{className:"whitespace-nowrap",children:[e.name,":"]}),l.jsx(C,{filter:e})]},e.id)}e("default",()=>{const{t:e}=a(),n=c(),g=w(e=>e.current_drive_user_id),[m,y]=u.useState([]),[v,_]=u.useState(!1),[C,k]=u.useState(1),[R,D]=u.useState(20),[O,E]=u.useState(0),[L,M]=u.useState([]),[$,z]=u.useState([]),[A,T]=u.useState(new Map),F=u.useRef(null),K=u.useCallback(()=>{k(1),M([])},[]),{sceneList:U,selectedScene:B,sceneLoading:Y,onSceneChange:H,dateRange:I,onDateChange:J,filters:P}=(({onFilterChange:e}={})=>{const{t:t}=a(),[n,l]=u.useState([]),[c,d]=u.useState(null),[i,o]=u.useState(!1),[f,x]=u.useState([p().add(-30,"d").startOf("day"),p().endOf("day")]),g=u.useMemo(()=>{n.find(e=>e.scene===c);const e=[];return s.log("filters",e),e},[c,n]);u.useEffect(()=>{(async()=>{o(!0);try{const e=await r.listUserDataScene(),t=Array.isArray(e)?e:[];l(t),t.length>0&&d(t[0].scene)}catch(e){s.error("ERROR: fetchSceneList",e),h.error(t("fetch_scene_list_failed"))}finally{o(!1)}})()},[]);const m=u.useCallback(t=>{d(t),e?.()},[e]),y=u.useCallback(t=>{t&&(x(t),e?.())},[e]);return{sceneList:n,selectedScene:c,sceneLoading:i,onSceneChange:m,dateRange:f,onDateChange:y,filters:g}})({onFilterChange:K}),W=u.useMemo(()=>{const e=U.find(e=>e.scene===B);return(e?.schemas||[]).map(e=>({id:e.id,accessorKey:e.id,header:e.header,size:"id"===e.id?100:150,meta:{editable:e.meta?.editable??!1,sortable:e.meta?.sortable??!1,ellipsis:{showTooltip:!0},editor:e.meta?.editor??!1}}))},[B,U]),q=u.useCallback(async()=>{if(B){F.current&&F.current.abort(),F.current=new AbortController,_(!0);try{const[e,a]=I,s={scene:B,page:C,page_size:R};e&&a&&(s.start_time=e.format(`${S} ${t}`),s.end_time=a.format(`${S} ${t}`)),L&&Array.isArray(L)&&L.length>0&&(s.order=L),g&&(s.target_user_id=g);const n=await r.searchUserData(s),l=(n.data||[]).map(e=>{const t={...e};for(const a in t){const e=t[a];if(null!==e&&"object"==typeof e)try{t[a]=JSON.stringify(e)}catch{t[a]=""}}return t});y(l),E(n.total||0),T(e=>{const t=new Map(e),a=new Map;return l.forEach(e=>{a.set(String(e.id),e)}),t.forEach((e,s)=>{const r=a.get(String(s));r&&t.set(String(s),r)}),t})}catch(e){if("CanceledError"===e.name||"AbortError"===e.name)return;s.error("ERROR: fetchTableData",e)}finally{_(!1)}}},[B,I,C,R,L,g]);u.useEffect(()=>{B&&q()},[B,I,C,R,L,q]),u.useEffect(()=>()=>{F.current&&F.current.abort()},[]);const G=u.useCallback(e=>{z(e),T(t=>{const a=new Map(t),s=new Set(e.map(e=>String(e)));t.forEach((e,t)=>{s.has(String(t))||a.delete(String(t))});const r=new Map;return m.forEach(e=>{r.set(String(e.id),e)}),e.forEach(e=>{if(!a.has(String(e))){const t=r.get(String(e));t&&a.set(String(e),t)}}),a})},[m]),Q=u.useMemo(()=>({selectedRowKeys:$,onChange:G}),[$,G]),V=async()=>{if(B)try{await r.deleteUserData({scene:B,ids:$,target_user_id:g}),await q(),z([]),T(new Map),h.success(e("delete_success"))}catch(t){s.error("ERROR: onDeleteSelected",t),h.error(e("delete_failed"))}},X=$.length>0;return l.jsxs("div",{className:"w-full h-dvh overflow-hidden flex flex-col",children:[l.jsx(i,{}),l.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[l.jsx(o,{}),l.jsxs("div",{className:"flex flex-col flex-1 overflow-x-auto",children:[l.jsxs("div",{className:"flex items-center justify-between mt-[12px] pl-[24px] pr-[24px]",children:[l.jsx("div",{className:"text-[24px] font-[500] text-[#111827] select-none",children:e("data_property")}),l.jsx(j,{type:"default",icon:l.jsx(b,{}),onClick:()=>n("/indicator"),children:e("switch_to_old_mode")})]}),l.jsx("div",{className:`pl-[24px] pr-[24px] ${f.filterContainer}`,children:l.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-[16px]",children:[l.jsx("div",{className:"flex items-center gap-[24px] flex-wrap",children:l.jsx(N,{sceneList:U,selectedScene:B,sceneLoading:Y,onSceneChange:H,dateRange:I,onDateChange:J,filters:P})}),l.jsxs("div",{className:"flex items-center gap-[16px]",children:[l.jsxs("span",{className:"text-[14px] text-[#666]",children:[e("selected"),": ",$.length]}),l.jsx(j,{type:"primary",onClick:async()=>{const t=W.slice(0,4),a=$.map(e=>A.get(String(e))||{id:e}).filter(Boolean);d.confirm({title:e("delete_selected_indicators"),content:l.jsxs(l.Fragment,{children:[l.jsx("div",{children:e("delete_selected_indicators_content")}),l.jsxs("div",{style:{marginTop:12},children:[l.jsxs("div",{style:{fontWeight:500,marginBottom:8},children:[e("selected_indicators"),":"]}),l.jsx("div",{className:"max-h-[200px] overflow-y-auto overflow-x-auto border border-[#d9d9d9] rounded-[4px] w-full",children:l.jsxs("table",{className:"w-full border-collapse",children:[l.jsx("thead",{children:l.jsx("tr",{className:"bg-[#fafafa] border-b border-[#f0f0f0]",children:t.map((e,t)=>l.jsx("th",{className:"text-left text-[14px] font-[500] text-[rgba(0,0,0,0.85)] px-[12px] py-[4px] border-r border-[#f0f0f0] last:border-r-0",children:e.header||e.id},e.id||t))})}),l.jsx("tbody",{children:a.map((e,a)=>l.jsx("tr",{className:"border-b border-[#f0f0f0] last:border-b-0",children:t.map((t,a)=>l.jsx("td",{className:"text-[14px] text-[#666] px-[12px] py-[4px] border-r border-[#f0f0f0] last:border-r-0 whitespace-nowrap max-w-[200px] overflow-hidden text-ellipsis",title:e[t.accessorKey]??"-",children:e[t.accessorKey]??"-"},t.id||a))},e.id||a))})]})})]})]}),onOk:V,OkButton:({loading:t,onClick:a})=>l.jsx(j,{size:"large",onClick:a,loading:t,style:{height:"36px",backgroundColor:"#EC221F",color:"#fff",border:"none"},children:e("delete")})})},disabled:!X,children:e("delete")})]})]})}),l.jsx("div",{className:"flex-1 flex flex-col overflow-hidden pr-[24px] pl-[24px]",children:l.jsx(x,{rowClassName:()=>f.editableRow,data:m,columns:W,loading:v,pagination:{total:O,pageSize:R,current:C},scroll:{x:"max-content",y:"auto"},rowKey:"id",sticky:!0,onChange:e=>{k(e.current),D(e.pageSize)},bordered:!0,size:"small",rowSelection:Q,handleSave:async(t,a)=>{if(!B)return;const n=a?.dataIndex,l=t[n];if(n)try{await r.updateUserData({scene:B,id:t.id,update_key:n,update_value:l,target_user_id:g}),h.success(e("update_success")),q()}catch(c){s.error("ERROR: updateUserData",c),h.error(e("update_failed"))}},onSortChange:(e,t)=>{M(a=>{const s=a.findIndex(t=>t.order_key===e);if(null===t)return s>=0?a.filter((e,t)=>t!==s):a;if(s>=0){const r=[...a];return r[s]={order_key:e,order_type:t},r}return[...a,{order_key:e,order_type:t}]}),k(1)},sortState:L})})]})]})]})})}}});
