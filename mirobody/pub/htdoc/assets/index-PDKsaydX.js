import{u as De,k as Ie,T as Ee,U as Me,V as ze,b as M,a as z,j as e,M as Oe}from"./index-BICubz86.js";import{r as n,e as u,B as w,t as Ke,u as ke,v as Ae,w as $e,x as se,I as Be,f as O}from"./vendor-antd-DoyqoZ7x.js";import{H as He}from"./index-CoRyhR67.js";import{M as Pe}from"./index-DUhhDYCf.js";import{s as h,T as Fe}from"./index-CoJZIexe.js";import{a as qe}from"./account-CsOayCF-.js";import"./vendor-firebase-D-efta1e.js";import"./logo-DuzqZi6-.js";import"./index-mABjyEMg.js";import"./vendor-monaco-3AoEMSHc.js";const{RangePicker:Le}=ke,Qe=[{label:"Last 7 Days",value:[u().add(-7,"d").startOf("day"),u().endOf("day")]},{label:"Last 14 Days",value:[u().add(-14,"d").startOf("day"),u().endOf("day")]},{label:"Last 30 Days",value:[u().add(-30,"d").startOf("day"),u().endOf("day")]},{label:"Last 90 Days",value:[u().add(-90,"d").startOf("day"),u().endOf("day")]}],re="HH:mm:ss",ne="YYYY-MM-DD",ie=(s,S=20)=>s?s.length<=S?s:"".concat(s.substring(0,S),"..."):"",at=()=>{const{t:s}=De(),S=Ie(),[b,K]=n.useState([]),[oe,k]=n.useState(!1),[v,ce]=n.useState([u().startOf("day"),u().endOf("day")]),[C,q]=n.useState([]),[T,L]=n.useState([]),[le,Q]=n.useState(""),[A,Y]=n.useState(""),[N,x]=n.useState(1),[R,de]=n.useState(20),[ue,fe]=n.useState(0),[xe,$]=n.useState(new Set),y=n.useRef(null),j=qe(t=>t.current_drive_user_id),[U,V]=n.useState([]),[W,G]=n.useState([]),[D,J]=n.useState(!1),[g,X]=n.useState([]),[pe,B]=n.useState(new Map),m=n.useRef(null),[I,me]=n.useState(!0),[H,Z]=n.useState([]),P=n.useCallback(async()=>{y.current&&y.current.abort(),y.current=new AbortController;const t=y.current.signal;try{k(!0);const[a,r]=v,c="".concat(ne," ").concat(re),l=Ee(Me({page:N,page_size:R,filters:{category:C,source:T},filterKeys:["category","source"],query:A,start_time:a==null?void 0:a.format(c),end_time:r==null?void 0:r.format(c),order:H}),ze("target_user_id",j)),o=await M.getHealthIndicator(l,t);if(t.aborted)return;K(o.data||[]),fe(o.total||0),k(!1),B(d=>{const p=new Map(d),_=new Map;return(o.data||[]).forEach(i=>{_.set(String(i.id),i)}),p.forEach((i,f)=>{const E=_.get(String(f));E&&p.set(String(f),E)}),p})}catch(a){if(a.name==="CanceledError"||a.name==="AbortError")return;z.error("ERROR: fetchIndicatorData",a)}finally{k(!1)}},[v,C,T,A,N,R,j,H]);n.useEffect(()=>{(async()=>{if(!D)try{const a=await M.getHealthIndicatorCategories(),r=Array.isArray(a==null?void 0:a.category)?a.category:[],c=Array.isArray(a==null?void 0:a.source)?a.source:[];V(r),G(c),J(!0)}catch(a){z.error("ERROR: fetchHealthIndicatorCategories",a),V([]),G([]),J(!0)}})()},[D]),n.useEffect(()=>()=>{y.current&&y.current.abort(),m.current&&clearTimeout(m.current)},[]),n.useEffect(()=>{D&&P()},[v,C,T,A,N,R,j,D,P]),n.useEffect(()=>{x(1)},[j]);const he=t=>{t&&(ce(t),x(1))},ye=t=>{q(t),x(1)},ge=t=>{L(t),x(1)},_e=t=>{const a=t.target.value;Q(a),m.current&&clearTimeout(m.current),m.current=setTimeout(()=>{Y(a),x(1)},500)},be=()=>{q([]),L([]),Q(""),Y(""),x(1),Z([]),m.current&&clearTimeout(m.current)},ee=[{id:"indicator",accessorKey:"indicator",header:s("indicator_name"),size:260,meta:{fixed:"start",editable:!0,sortable:!0,ellipsis:{showTooltip:!0}}},{id:"full_name",accessorKey:"full_name",header:s("indicator_full_name"),size:200,meta:{editable:!0,ellipsis:{showTooltip:!0}}},{id:"value",accessorKey:"value",header:s("value"),size:300,meta:{editable:!0,ellipsis:{showTooltip:!0}}},{id:"start_time",accessorKey:"start_time",header:s("indicator_start_time"),meta:{editable:!0,sortable:!0}},{id:"end_time",accessorKey:"end_time",header:s("indicator_end_time"),meta:{editable:!0}},{id:"indicator_standard",accessorKey:"indicator_standard",header:s("indicator_standard"),meta:{editable:!0}},{id:"comment",accessorKey:"comment",header:s("indicator_comment"),size:300,meta:{editable:!0,ellipsis:{showTooltip:!0}}},{id:"llm_description",accessorKey:"llm_description",header:s("indicator_llm_description"),size:300,meta:{editable:!0,ellipsis:{showTooltip:!0}}},{id:"search_type",accessorKey:"search_type",header:s("search_type"),size:100,meta:{ellipsis:{showTooltip:!0}}},{id:"indicator_sim",accessorKey:"indicator_sim",header:s("indicator_sim"),size:150,meta:{ellipsis:{showTooltip:!0}}},{id:"source",accessorKey:"source",header:"source",size:150,meta:{ellipsis:{showTooltip:!0}}},{id:"file_name",accessorKey:"file_name",header:"file_name",size:300,meta:{sortable:!0,ellipsis:{showTooltip:!0}}},{id:"original_data",accessorKey:"original_data",header:"original_data",size:300,meta:{editor:{type:"json"}}}],je=t=>{x(t.current),de(t.pageSize)},we=(t,a)=>{Z(r=>{const c=r.findIndex(l=>l.order_key===t);if(a===null)return c>=0?r.filter((l,o)=>o!==c):r;if(c>=0){const l=[...r];return l[c]={order_key:t,order_type:a},l}else return[...r,{order_key:t,order_type:a}]}),x(1)},Se=async(t,a)=>{const r=b.find(i=>i.id===t.id);if(!r)return;const c={...r},l={};if(ee.filter(i=>{var f;return((f=i.meta)==null?void 0:f.editable)===!0}).map(i=>i.accessorKey).filter(Boolean).forEach(i=>{t[i]!==c[i]&&(l[i]=t[i])}),Object.keys(l).length===0)return;const d=a?"".concat(a.rowId,"-").concat(a.dataIndex):null;$(d?i=>new Set(i).add(d):i=>new Set(i).add(t.id));const p=[...b],_=p.findIndex(i=>t.id===i.id);_>-1&&(p[_]={...p[_],...t},K(p));try{await M.updateHealthIndicator(t.id,l,j);const i=ie(t.full_name||t.indicator||"");O.success("".concat(i," ").concat(s("update_success")))}catch(i){z.error("ERROR: updateHealthIndicator",i),K(E=>{const F=[...E],ae=F.findIndex(Re=>Re.id===t.id);return ae>-1&&(F[ae]=c),F});const f=ie(t.full_name||t.indicator||"");O.error("".concat(f," ").concat(s("update_failed")))}finally{$(i=>{const f=new Set(i);return d?f.delete(d):f.delete(t.id),f})}},te=n.useCallback(t=>{X(t),B(a=>{const r=new Map(a),c=new Set(t.map(o=>String(o)));a.forEach((o,d)=>{c.has(String(d))||r.delete(String(d))});const l=new Map;return b.forEach(o=>{l.set(String(o.id),o)}),t.forEach(o=>{if(!r.has(String(o))){const d=l.get(String(o));d&&r.set(String(o),d)}}),r})},[b]),ve=n.useMemo(()=>({selectedRowKeys:g,onChange:te}),[g,te]),Ce=async()=>{try{await M.deleteHealthIndicator(g),await P(),X([]),B(new Map),O.success(s("delete_success"))}catch(t){z.error("ERROR: onDeleteSelected",t),O.error(s("delete_failed"))}},Te=async()=>{const t=g.map(a=>{const r=pe.get(String(a));return r?{name:r.indicator||r.full_name||"",id:r.id,startTime:r.start_time||"",endTime:r.end_time||""}:{name:"",id:a,startTime:"",endTime:""}}).filter(Boolean);Oe.confirm({title:s("delete_selected_indicators"),content:e.jsxs(e.Fragment,{children:[e.jsx("div",{children:s("delete_selected_indicators_content")}),e.jsxs("div",{style:{marginTop:12},children:[e.jsxs("div",{style:{fontWeight:500,marginBottom:8},children:[s("selected_indicators"),":"]}),e.jsx("div",{className:"max-h-[200px] overflow-y-auto overflow-x-auto border border-[#d9d9d9] rounded-[4px] w-full",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-[#fafafa] border-b border-[#f0f0f0]",children:[e.jsx("th",{className:"text-left text-[14px] font-[500] text-[rgba(0,0,0,0.85)] px-[12px] py-[4px] border-r border-[#f0f0f0]",children:s("indicator_name")}),e.jsx("th",{className:"text-left text-[14px] font-[500] text-[rgba(0,0,0,0.85)] px-[12px] py-[4px] border-r border-[#f0f0f0]",children:"ID"}),e.jsx("th",{className:"text-left text-[14px] font-[500] text-[rgba(0,0,0,0.85)] px-[12px] py-[4px] border-r border-[#f0f0f0]",children:s("indicator_start_time")}),e.jsx("th",{className:"text-left text-[14px] font-[500] text-[rgba(0,0,0,0.85)] px-[12px] py-[4px]",children:s("indicator_end_time")})]})}),e.jsx("tbody",{children:t.map((a,r)=>e.jsxs("tr",{className:"border-b border-[#f0f0f0] last:border-b-0",children:[e.jsx("td",{className:"text-[14px] text-[#666] px-[12px] py-[4px] border-r border-[#f0f0f0] whitespace-nowrap",children:a.name||"-"}),e.jsx("td",{className:"text-[14px] text-[#666] px-[12px] py-[4px] border-r border-[#f0f0f0] whitespace-nowrap",children:a.id}),e.jsx("td",{className:"text-[14px] text-[#666] px-[12px] py-[4px] border-r border-[#f0f0f0] whitespace-nowrap",children:a.startTime||"-"}),e.jsx("td",{className:"text-[14px] text-[#666] px-[12px] py-[4px] whitespace-nowrap",children:a.endTime||"-"})]},r))})]})})]})]}),onOk:Ce,OkButton:({loading:a,onClick:r})=>e.jsx(w,{size:"large",onClick:r,loading:a,style:{height:"36px",backgroundColor:"#EC221F",color:"#fff",border:"none"},children:s("delete")})})},Ne=g.length>0;return e.jsxs("div",{className:"w-full h-dvh overflow-hidden flex flex-col",children:[e.jsx(He,{}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx(Pe,{}),e.jsxs("div",{className:"flex flex-col flex-1 overflow-x-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mt-[12px] pl-[24px] pr-[24px]",children:[e.jsx("div",{className:"text-[24px] font-[500] text-[#111827] select-none",children:s("data_property")}),e.jsx(w,{type:"default",icon:e.jsx(Ke,{}),onClick:()=>S("/indicator/new"),children:s("switch_to_new_mode")})]}),e.jsxs("div",{className:"pl-[24px] ".concat(h.filterContainer),children:[e.jsxs("div",{className:h.filterHeader,children:[e.jsxs("div",{className:"flex items-center gap-[16px] flex-1",children:[e.jsxs("div",{children:[s("date_range"),":"]}),e.jsx(Le,{presets:[{label:e.jsx("span",{"aria-label":"Current Time to End of Day",children:"Now ~ EOD"}),value:()=>[u(),u().endOf("day")]},...Qe],format:"".concat(ne," ").concat(re),onChange:he,value:v,showTime:!0})]}),e.jsxs("div",{className:"flex items-center gap-[16px]",children:[e.jsx(w,{onClick:be,children:s("reset")}),e.jsxs("span",{className:"text-[14px] text-[#666]",children:[s("selected"),": ",g.length]}),e.jsx(w,{type:"primary",onClick:Te,disabled:!Ne,children:s("delete")}),e.jsx(w,{type:"link",onClick:()=>me(!I),className:h.expandButton,icon:I?e.jsx(Ae,{}):e.jsx($e,{}),children:s(I?"collapse":"expand")})]})]}),I&&e.jsxs("div",{className:"".concat(h.filterContent," flex flex-col gap-[16px]"),children:[e.jsxs("div",{className:"flex items-center gap-[16px]",children:[e.jsxs("div",{children:[s("category"),":"]}),e.jsx(se,{mode:"multiple",className:h.multipleSelect,style:{width:500},placeholder:s("please_select"),options:Array.isArray(U)?U.map(t=>({label:t,value:t})):[],onChange:ye,value:C,maxTagCount:"responsive"})]}),e.jsxs("div",{className:"flex items-center gap-[16px]",children:[e.jsxs("div",{children:[s("source"),":"]}),e.jsx(se,{mode:"multiple",className:h.multipleSelect,style:{width:500},placeholder:s("please_select"),options:Array.isArray(W)?W.map(t=>({label:t,value:t})):[],onChange:ge,value:T,maxTagCount:"responsive"})]}),e.jsxs("div",{className:"flex items-center gap-[16px]",children:[e.jsxs("div",{children:[s("search"),":"]}),e.jsx(Be.TextArea,{style:{width:500},placeholder:s("search_placeholder"),value:le,onChange:_e,allowClear:!0,autoSize:{minRows:1,maxRows:4}})]})]})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden pr-[24px] pl-[24px]",children:e.jsx(Fe,{rowClassName:()=>h.editableRow,data:b,columns:ee,loading:oe,pagination:{total:ue,pageSize:R,current:N},scroll:{x:"max-content",y:"auto"},rowKey:"id",sticky:!0,onChange:je,bordered:!0,size:"small",rowSelection:ve,handleSave:Se,updatingIds:xe,onSortChange:we,sortState:H})})]})]})]})};export{at as default};
