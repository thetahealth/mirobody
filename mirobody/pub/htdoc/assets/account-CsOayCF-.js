var le=Object.defineProperty;var de=(t,e,n)=>e in t?le(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var P=(t,e,n)=>de(t,typeof e!="symbol"?e+"":e,n);import{a as u,v as fe,A as he,r as _e,P as w,a0 as S,a1 as pe,a2 as ge,M as R,G as y,o as B,q as me,b as J,a3 as b,a4 as D,a5 as F,a6 as I,a7 as W}from"./index-BICubz86.js";import{e as ve}from"./vendor-antd-DoyqoZ7x.js";function we(t){return t&&typeof t.then=="function"}Promise.resolve(!1);var Se=Promise.resolve(!0),_=Promise.resolve();function m(t,e){return t||(t=0),new Promise(function(n){return setTimeout(function(){return n(e)},t)})}function ye(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function M(){return Math.random().toString(36).substring(2)}var N=0;function k(){var t=Date.now()*1e3;return t<=N&&(t=N+1),N=t,t}function Le(){return typeof navigator<"u"&&typeof navigator.locks<"u"&&typeof navigator.locks.request=="function"}var be=k,Ce="native";function Ie(t){var e={time:k(),messagesCallback:null,bc:new BroadcastChannel(t),subFns:[]};return e.bc.onmessage=function(n){e.messagesCallback&&e.messagesCallback(n.data)},e}function Ee(t){t.bc.close(),t.subFns=[]}function Me(t,e){try{return t.bc.postMessage(e,!1),_}catch(n){return Promise.reject(n)}}function ke(t,e){t.messagesCallback=e}function Pe(){if(typeof globalThis<"u"&&globalThis.Deno&&globalThis.Deno.args)return!0;if((typeof window<"u"||typeof self<"u")&&typeof BroadcastChannel=="function"){if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0}else return!1}function Te(){return 150}var Oe={create:Ie,close:Ee,onMessage:ke,postMessage:Me,canBeUsed:Pe,type:Ce,averageResponseTime:Te,microSeconds:be};class H{constructor(e){P(this,"ttl");P(this,"map",new Map);P(this,"_to",!1);this.ttl=e}has(e){const n=this.map.get(e);return typeof n>"u"?!1:n<U()-this.ttl?(this.map.delete(e),!1):!0}add(e){this.map.delete(e),this.map.set(e,U()),this._to||(this._to=!0,setTimeout(()=>{this._to=!1,Re(this)},0))}clear(){this.map.clear()}}function Re(t){const e=U()-t.ttl,n=t.map[Symbol.iterator]();for(;;){const r=n.next().value;if(!r)break;const i=r[0];if(r[1]<e)t.map.delete(i);else break}}function U(){return Date.now()}function A(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=JSON.parse(JSON.stringify(t));return typeof e.webWorkerSupport>"u"&&(e.webWorkerSupport=!0),e.idb||(e.idb={}),e.idb.ttl||(e.idb.ttl=1e3*45),e.idb.fallbackInterval||(e.idb.fallbackInterval=150),t.idb&&typeof t.idb.onclose=="function"&&(e.idb.onclose=t.idb.onclose),e.localstorage||(e.localstorage={}),e.localstorage.removeTimeout||(e.localstorage.removeTimeout=1e3*60),t.methods&&(e.methods=t.methods),e.node||(e.node={}),e.node.ttl||(e.node.ttl=1e3*60*2),e.node.maxParallelWrites||(e.node.maxParallelWrites=2048),typeof e.node.useFastPath>"u"&&(e.node.useFastPath=!0),e}var De=k,Fe="pubkey.broadcast-channel-0-",p="messages",O={durability:"relaxed"},We="idb";function V(){if(typeof indexedDB<"u")return indexedDB;if(typeof window<"u"){if(typeof window.mozIndexedDB<"u")return window.mozIndexedDB;if(typeof window.webkitIndexedDB<"u")return window.webkitIndexedDB;if(typeof window.msIndexedDB<"u")return window.msIndexedDB}return!1}function x(t){t.commit&&t.commit()}function Ne(t){var e=V(),n=Fe+t,r=e.open(n);return r.onupgradeneeded=function(i){var s=i.target.result;s.createObjectStore(p,{keyPath:"id",autoIncrement:!0})},new Promise(function(i,s){r.onerror=function(o){return s(o)},r.onsuccess=function(){i(r.result)}})}function Ue(t,e,n){var r=Date.now(),i={uuid:e,time:r,data:n},s=t.transaction([p],"readwrite",O);return new Promise(function(o,a){s.oncomplete=function(){return o()},s.onerror=function(l){return a(l)};var c=s.objectStore(p);c.add(i),x(s)})}function Be(t,e){var n=t.transaction(p,"readonly",O),r=n.objectStore(p),i=[],s=IDBKeyRange.bound(e+1,1/0);if(r.getAll){var o=r.getAll(s);return new Promise(function(c,l){o.onerror=function(d){return l(d)},o.onsuccess=function(d){c(d.target.result)}})}function a(){try{return s=IDBKeyRange.bound(e+1,1/0),r.openCursor(s)}catch(c){return r.openCursor()}}return new Promise(function(c,l){var d=a();d.onerror=function(f){return l(f)},d.onsuccess=function(f){var g=f.target.result;g?g.value.id<e+1?g.continue(e+1):(i.push(g.value),g.continue()):(x(n),c(i))}})}function Ae(t,e){if(t.closed)return Promise.resolve([]);var n=t.db.transaction(p,"readwrite",O),r=n.objectStore(p);return Promise.all(e.map(function(i){var s=r.delete(i);return new Promise(function(o){s.onsuccess=function(){return o()}})}))}function xe(t,e){var n=Date.now()-e,r=t.transaction(p,"readonly",O),i=r.objectStore(p),s=[];return new Promise(function(o){i.openCursor().onsuccess=function(a){var c=a.target.result;if(c){var l=c.value;l.time<n?(s.push(l),c.continue()):(x(r),o(s))}else o(s)}})}function $e(t){return xe(t.db,t.options.idb.ttl).then(function(e){return Ae(t,e.map(function(n){return n.id}))})}function Ke(t,e){return e=A(e),Ne(t).then(function(n){var r={closed:!1,lastCursorId:0,channelName:t,options:e,uuid:M(),eMIs:new H(e.idb.ttl*2),writeBlockPromise:_,messagesCallback:null,readQueuePromises:[],db:n};return n.onclose=function(){r.closed=!0,e.idb.onclose&&e.idb.onclose()},j(r),r})}function j(t){t.closed||X(t).then(function(){return m(t.options.idb.fallbackInterval)}).then(function(){return j(t)})}function qe(t,e){return!(t.uuid===e.uuid||e.eMIs.has(t.id)||t.data.time<e.messagesCallbackTime)}function X(t){return t.closed||!t.messagesCallback?_:Be(t.db,t.lastCursorId).then(function(e){var n=e.filter(function(r){return!!r}).map(function(r){return r.id>t.lastCursorId&&(t.lastCursorId=r.id),r}).filter(function(r){return qe(r,t)}).sort(function(r,i){return r.time-i.time});return n.forEach(function(r){t.messagesCallback&&(t.eMIs.add(r.id),t.messagesCallback(r.data))}),_})}function Qe(t){t.closed=!0,t.db.close()}function ze(t,e){return t.writeBlockPromise=t.writeBlockPromise.then(function(){return Ue(t.db,t.uuid,e)}).then(function(){ye(0,10)===0&&$e(t)}),t.writeBlockPromise}function Ge(t,e,n){t.messagesCallbackTime=n,t.messagesCallback=e,X(t)}function Ye(){return!!V()}function Je(t){return t.idb.fallbackInterval*2}var He={create:Ke,close:Qe,onMessage:Ge,postMessage:ze,canBeUsed:Ye,type:We,averageResponseTime:Je,microSeconds:De},Ve=k,je="pubkey.broadcastChannel-",Xe="localstorage";function Z(){var t;if(typeof window>"u")return null;try{t=window.localStorage,t=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return t}function ee(t){return je+t}function Ze(t,e){return new Promise(function(n){m().then(function(){var r=ee(t.channelName),i={token:M(),time:Date.now(),data:e,uuid:t.uuid},s=JSON.stringify(i);Z().setItem(r,s);var o=document.createEvent("Event");o.initEvent("storage",!0,!0),o.key=r,o.newValue=s,window.dispatchEvent(o),n()})})}function et(t,e){var n=ee(t),r=function(s){s.key===n&&e(JSON.parse(s.newValue))};return window.addEventListener("storage",r),r}function tt(t){window.removeEventListener("storage",t)}function nt(t,e){if(e=A(e),!te())throw new Error("BroadcastChannel: localstorage cannot be used");var n=M(),r=new H(e.localstorage.removeTimeout),i={channelName:t,uuid:n,eMIs:r};return i.listener=et(t,function(s){i.messagesCallback&&s.uuid!==n&&(!s.token||r.has(s.token)||s.data.time&&s.data.time<i.messagesCallbackTime||(r.add(s.token),i.messagesCallback(s.data)))}),i}function rt(t){tt(t.listener)}function it(t,e,n){t.messagesCallbackTime=n,t.messagesCallback=e}function te(){var t=Z();if(!t)return!1;try{var e="__broadcastchannel_check";t.setItem(e,"works"),t.removeItem(e)}catch(n){return!1}return!0}function st(){var t=120,e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?t*2:t}var ot={create:nt,close:rt,onMessage:it,postMessage:Ze,canBeUsed:te,type:Xe,averageResponseTime:st,microSeconds:Ve},ne=k,at="simulate",$=new Set;function ct(t){var e={time:ne(),name:t,messagesCallback:null};return $.add(e),e}function ut(t){$.delete(t)}var re=5;function lt(t,e){return new Promise(function(n){return setTimeout(function(){var r=Array.from($);r.forEach(function(i){i.name===t.name&&i!==t&&i.messagesCallback&&i.time<e.time&&i.messagesCallback(e)}),n()},re)})}function dt(t,e){t.messagesCallback=e}function ft(){return!0}function ht(){return re}var _t={create:ct,close:ut,onMessage:dt,postMessage:lt,canBeUsed:ft,type:at,averageResponseTime:ht,microSeconds:ne},q=[Oe,He,ot];function pt(t){var e=[].concat(t.methods,q).filter(Boolean);if(t.type){if(t.type==="simulate")return _t;var n=e.find(function(i){return i.type===t.type});if(n)return n;throw new Error("method-type "+t.type+" not found")}t.webWorkerSupport||(e=e.filter(function(i){return i.type!=="idb"}));var r=e.find(function(i){return i.canBeUsed()});if(r)return r;throw new Error("No usable method found in "+JSON.stringify(q.map(function(i){return i.type})))}var ie=new Set,gt=0,T=function(e,n){this.id=gt++,ie.add(this),this.name=e,this.options=A(n),this.method=pt(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,mt(this)};T._pubkey=!0;T.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return Q(this,"message",e)},postInternal:function(e){return Q(this,"internal",e)},set onmessage(t){var e=this.method.microSeconds(),n={time:e,fn:t};G(this,"message",this._onML),t&&typeof t=="function"?(this._onML=n,z(this,"message",n)):this._onML=null},addEventListener:function(e,n){var r=this.method.microSeconds(),i={time:r,fn:n};z(this,e,i)},removeEventListener:function(e,n){var r=this._addEL[e].find(function(i){return i.fn===n});G(this,e,r)},close:function(){var e=this;if(!this.closed){ie.delete(this),this.closed=!0;var n=this._prepP?this._prepP:_;return this._onML=null,this._addEL.message=[],n.then(function(){return Promise.all(Array.from(e._uMP))}).then(function(){return Promise.all(e._befC.map(function(r){return r()}))}).then(function(){return e.method.close(e._state)})}},get type(){return this.method.type},get isClosed(){return this.closed}};function Q(t,e,n){var r=t.method.microSeconds(),i={time:r,type:e,data:n},s=t._prepP?t._prepP:_;return s.then(function(){var o=t.method.postMessage(t._state,i);return t._uMP.add(o),o.catch().then(function(){return t._uMP.delete(o)}),o})}function mt(t){var e=t.method.create(t.name,t.options);we(e)?(t._prepP=e,e.then(function(n){t._state=n})):t._state=e}function se(t){return t._addEL.message.length>0||t._addEL.internal.length>0}function z(t,e,n){t._addEL[e].push(n),vt(t)}function G(t,e,n){t._addEL[e]=t._addEL[e].filter(function(r){return r!==n}),wt(t)}function vt(t){if(!t._iL&&se(t)){var e=function(i){t._addEL[i.type].forEach(function(s){i.time>=s.time&&s.fn(i.data)})},n=t.method.microSeconds();t._prepP?t._prepP.then(function(){t._iL=!0,t.method.onMessage(t._state,e,n)}):(t._iL=!0,t.method.onMessage(t._state,e,n))}}function wt(t){if(t._iL&&!se(t)){t._iL=!1;var e=t.method.microSeconds();t.method.onMessage(t._state,null,e)}}function St(t){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var e=self.close.bind(self);self.close=function(){return t(),e()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){t()},!0),window.addEventListener("unload",function(){t()},!0)}}function yt(t){process.on("exit",function(){return t()}),process.on("beforeExit",function(){return t().then(function(){return process.exit()})}),process.on("SIGINT",function(){return t().then(function(){return process.exit()})}),process.on("uncaughtException",function(e){return t().then(function(){console.trace(e),process.exit(101)})})}var Lt=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",bt=Lt?yt:St,E=new Set,Y=!1;function Ct(){Y||(Y=!0,bt(Et))}function It(t){if(Ct(),typeof t!="function")throw new Error("Listener is no function");E.add(t);var e={remove:function(){return E.delete(t)},run:function(){return E.delete(t),t()}};return e}function Et(){var t=[];return E.forEach(function(e){t.push(e()),E.delete(e)}),Promise.all(t)}function v(t,e){var n={context:"leader",action:e,token:t.token};return t.broadcastChannel.postInternal(n)}function oe(t){t.isLeader=!0,t._hasLeader=!0;var e=It(function(){return t.die()});t._unl.push(e);var n=function(i){i.context==="leader"&&i.action==="apply"&&v(t,"tell"),i.context==="leader"&&i.action==="tell"&&!t._dpLC&&(t._dpLC=!0,t._dpL(),v(t,"tell"))};return t.broadcastChannel.addEventListener("internal",n),t._lstns.push(n),v(t,"tell")}var ae=function(e,n){var r=this;this.broadcastChannel=e,e._befC.push(function(){return r.die()}),this._options=n,this.isLeader=!1,this.isDead=!1,this.token=M(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+e.method.type+"||"+e.name};ae.prototype={hasLeader:function(){var e=this;return navigator.locks.query().then(function(n){var r=n.held?n.held.filter(function(i){return i.name===e.lN}):[];return!!(r&&r.length>0)})},awaitLeadership:function(){var e=this;if(!this._wLMP){this._wKMC.c=new AbortController;var n=new Promise(function(r,i){e._wKMC.res=r,e._wKMC.rej=i});this._wLMP=new Promise(function(r,i){navigator.locks.request(e.lN,{signal:e._wKMC.c.signal},function(){return e._wKMC.c=void 0,oe(e),r(),n}).catch(function(s){e._wKMC.rej&&e._wKMC.rej(s),i(s)})})}return this._wLMP},set onduplicate(t){},die:function(){var e=this;return this._lstns.forEach(function(n){return e.broadcastChannel.removeEventListener("internal",n)}),this._lstns=[],this._unl.forEach(function(n){return n.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),v(this,"death")}};var ce=function(e,n){var r=this;this.broadcastChannel=e,this._options=n,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=M(),this._aplQ=_,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var i=function(o){o.context==="leader"&&(o.action==="death"&&(r._hasLeader=!1),o.action==="tell"&&(r._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",i),this._lstns.push(i)};ce.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(e){var n=this;if(this.isLeader)return m(0,!0);if(this.isDead)return m(0,!1);if(this._aplQC>1)return this._aplQ;var r=function(){if(n.isLeader)return Se;var s=!1,o,a=new Promise(function(d){o=function(){s=!0,d()}}),c=function(f){f.context==="leader"&&f.token!=n.token&&(f.action==="apply"&&f.token>n.token&&o(),f.action==="tell"&&(o(),n._hasLeader=!0))};n.broadcastChannel.addEventListener("internal",c);var l=e?n._options.responseTime*4:n._options.responseTime;return v(n,"apply").then(function(){return Promise.race([m(l),a.then(function(){return Promise.reject(new Error)})])}).then(function(){return v(n,"apply")}).then(function(){return Promise.race([m(l),a.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return n.broadcastChannel.removeEventListener("internal",c),s?!1:oe(n).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return r()}).then(function(){n._aplQC=n._aplQC-1}),this._aplQ.then(function(){return n.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=Mt(this)),this._aLP},set onduplicate(t){this._dpL=t},die:function(){var e=this;return this._lstns.forEach(function(n){return e.broadcastChannel.removeEventListener("internal",n)}),this._lstns=[],this._unl.forEach(function(n){return n.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,v(this,"death")}};function Mt(t){return t.isLeader?_:new Promise(function(e){var n=!1;function r(){n||(n=!0,t.broadcastChannel.removeEventListener("internal",s),e(!0))}t.applyOnce().then(function(){t.isLeader&&r()});var i=function(){return m(t._options.fallbackInterval).then(function(){if(!(t.isDead||n))if(t.isLeader)r();else return t.applyOnce(!0).then(function(){t.isLeader?r():i()})})};i();var s=function(a){a.context==="leader"&&a.action==="death"&&(t._hasLeader=!1,t.applyOnce().then(function(){t.isLeader&&r()}))};t.broadcastChannel.addEventListener("internal",s),t._lstns.push(s)})}function kt(t,e){return t||(t={}),t=JSON.parse(JSON.stringify(t)),t.fallbackInterval||(t.fallbackInterval=3e3),t.responseTime||(t.responseTime=e.method.averageResponseTime(e.options)),t}function Pt(t,e){if(t._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");e=kt(e,t);var n=Le()?new ae(t,e):new ce(t,e);return t._befC.push(function(){return n.die()}),t._leaderElector=n,n}class Tt{constructor(e){this.userId=e,this.ws=null,this.url=null,this.connectionId=null,this.readyState=WebSocket.CLOSED,this.pingInterval=null,this.reconnectAttempts=0,this.PING_INTERVAL=3e4,this.generateConnectionId()}generateConnectionId(){if(!this.userId)throw new Error("WebSocketConnection::userId is required");const e="WEBSOCKET_CONNECTION_ID_".concat(this.userId),n=localStorage.getItem(e);n&&n.startsWith("".concat(this.userId,"_"))?this.connectionId=n:(this.connectionId="".concat(this.userId,"_").concat(fe()),localStorage.setItem(e,this.connectionId))}getSocketUrl(){const e=localStorage.getItem(he),n=_e();return e?(this.connectionId||this.generateConnectionId(),"".concat(n.replace(/^http/,"ws"),"/ws/upload-health-report?token=").concat(e,"&connectionId=").concat(this.connectionId)):(u.warn("WebSocketConnection::No ACCESS_TOKEN, cannot generate WebSocket URL"),null)}startHeartbeat(){this.pingInterval||(this.sendPing(),this.pingInterval=setInterval(()=>{this.sendPing()},this.PING_INTERVAL))}sendPing(){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=JSON.stringify({type:"ping",timestamp:ve().format("YYYY-MM-DDTHH:mm:ss.SSSSSS")});try{this.ws.send(e)}catch(n){u.error("WebSocketConnection::Failed to send ping for user ".concat(this.userId,", connectionId: ").concat(this.connectionId,":"),n)}}}stopHeartbeat(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null)}disconnect(){this.stopHeartbeat(),this.ws&&(this.ws.close(),this.ws=null),this.readyState=WebSocket.CLOSED}}class Ot{constructor(){this.connections=new Map,this.messageChannel=null,this.leaderChannel=null,this.elector=null,this.listeners=new Set,this.leaderConnectionStates=new Map,this.connectResolvers=new Map,this.initBroadcastChannel()}initBroadcastChannel(){this.messageChannel=new T("upload-websocket-messages"),this.leaderChannel=new T("upload-websocket-leader"),this.elector=Pt(this.leaderChannel,{fallbackInterval:500,responseTime:500}),this.elector.onduplicate=()=>{u.warn("WebSocketManager::Duplicate leader detected!")},this.messageChannel.onmessage=e=>{this.handleBroadcastMessage(e)}}getConnection(e){return e?(this.connections.has(e)||this.connections.set(e,new Tt(e)),this.connections.get(e)):(u.warn("WebSocketManager::No userId provided"),null)}getCurrentConnection(){const e=h.getState().current_drive_user_id||"";return this.getConnection(e)}async tryConnect(){const e=this.getCurrentConnection();if(!e)throw u.error("WebSocketManager::tryConnect - no current_drive_user_id"),new Error("ERROR:: tryConnect no connection");if(this.elector.isLeader||await this.elector.awaitLeadership(),!(e.ws&&e.ws.readyState===WebSocket.OPEN)){if(e.url=e.getSocketUrl(),!e.url)throw u.error("WebSocketManager::tryConnect - cannot generate URL"),new Error("ERROR:: tryConnect no URL");try{e.ws=new WebSocket(e.url),e.readyState=WebSocket.CONNECTING,e.ws.onopen=()=>{e.readyState=WebSocket.OPEN,e.reconnectAttempts=0,this.broadcastMessage({type:"connection_state",userId:e.userId,state:"open",readyState:WebSocket.OPEN,connectionId:e.connectionId}),this.notifyListeners("open",null,e.userId),e.startHeartbeat()},e.ws.onmessage=n=>{try{const r=JSON.parse(n.data);this.notifyListeners("message",r,e.userId),this.broadcastMessage({type:"message",userId:e.userId,payload:r})}catch(r){u.error("WebSocketManager::Failed to parse message:",r)}},e.ws.onerror=n=>{u.error("WebSocketManager::WebSocket error:",n),e.readyState=WebSocket.CLOSED,this.broadcastMessage({type:"connection_state",userId:e.userId,state:"error",readyState:WebSocket.CLOSED,connectionId:e.connectionId}),this.notifyListeners("error",n,e.userId)},e.ws.onclose=n=>{e.readyState=WebSocket.CLOSED,e.stopHeartbeat(),this.broadcastMessage({type:"connection_state",userId:e.userId,state:"close",readyState:WebSocket.CLOSED,connectionId:e.connectionId,code:n.code,reason:n.reason}),this.notifyListeners("close",n,e.userId)}}catch(n){u.error("WebSocketManager::Failed to create WebSocket:",n),e.readyState=WebSocket.CLOSED,this.broadcastMessage({type:"connection_state",userId:e.userId,state:"error",readyState:WebSocket.CLOSED,connectionId:e.connectionId}),this.notifyListeners("error",n,e.userId)}}}disconnect(e){let n=e;if(!n){const i=this.getCurrentConnection();i&&(n=i.userId)}const r=this.connections.get(n);r&&(r.disconnect(),this.broadcastMessage({type:"connection_state",userId:n,state:"close",readyState:WebSocket.CLOSED,connectionId:r.connectionId}))}sendMessage(e){const n=this.getCurrentConnection();if(!n){u.error("WebSocketManager:: sendMessage :: Cannot send message - no current connection");return}if(!this.elector.isLeader){this.broadcastMessage({type:"send_message_request",userId:n.userId,connectionId:n.connectionId,message:typeof e=="string"?e:JSON.stringify(e)});return}if(n.ws&&n.ws.readyState===WebSocket.OPEN)try{const r=typeof e=="string"?e:JSON.stringify(e);n.ws.send(r)}catch(r){u.error("WebSocketManager:: sendMessage :: Failed to send message:",r)}else u.error("WebSocketManager:: sendMessage :: WebSocket not connected, cannot send message")}handleBroadcastMessage(e){if(!(!e||!e.type)){if(e.type==="connection_state"){const n=e.userId,r=this.connections.get(n);r&&(r.readyState=e.readyState)}else if(e.type==="message"){const n=e.userId;e.payload&&this.notifyListeners("message",e.payload,n)}else if(e.type==="send_message_request"&&this.elector.isLeader&&e.message&&e.userId){const n=this.connections.get(e.userId);if(!n){u.error("WebSocketManager::Leader received message request for unknown user");return}if(n.ws&&n.ws.readyState===WebSocket.OPEN)try{n.ws.send(e.message)}catch(r){u.error("WebSocketManager::Failed to forward message to WebSocket for user ".concat(n.userId,":"),r)}else u.error("WebSocketManager::WebSocket not connected for user ".concat(n.userId,", cannot forward message"))}}}addListener(e){this.listeners.add(e)}removeListener(e){this.listeners.delete(e)}notifyListeners(e,n,r){this.listeners.forEach(i=>{try{i(e,n,r)}catch(s){u.error("WebSocketManager::Listener error:",s)}})}broadcastMessage(e){if(this.messageChannel)try{this.messageChannel.postMessage(e)}catch(n){}}isConnected(){const e=this.getCurrentConnection();return e&&e.ws&&e.ws.readyState===WebSocket.OPEN}isConnecting(){const e=this.getCurrentConnection();return e&&e.ws&&e.ws.readyState===WebSocket.CONNECTING}async ensureConnected(){var n;if(!(h.getState().current_drive_user_id||""))throw new Error("No current_drive_user_id");return(n=this.elector)!=null&&n.isLeader&&(this.isConnected()||await this.tryConnect()),!0}getReadyState(){const e=this.getCurrentConnection();return e?e.readyState:WebSocket.CLOSED}getConnectionId(){const e=this.getCurrentConnection();return e?e.connectionId:null}cleanup(){for(const[e,n]of this.connections)n.disconnect();this.connections.clear(),this.messageChannel&&this.messageChannel.close(),this.leaderChannel&&this.leaderChannel.close(),this.elector&&this.elector.die()}}let L=null;function Rt(){if(!L&&(L=new Ot,typeof window<"u")){const t=()=>{var e;L&&((e=L.elector)!=null&&e.isLeader)&&L.cleanup()};window.addEventListener("pagehide",t),window.addEventListener("beforeunload",t)}return L}const ue=t=>t?t.includes("image")?w.IMAGE:t.includes("pdf")?w.PDF:t.includes("mp4")||t.includes("video")?w.MP4:t==="text/plain"?w.TEXT:Dt(t)?w.EXCEL:w.FILE:null,Dt=t=>["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/vnd.ms-excel.sheet.macroEnabled.12","application/vnd.ms-excel.sheet.binary.macroEnabled.12"].includes(t),$t=()=>new Promise((t,e)=>{try{const n=document.createElement("input");n.type="file",n.multiple=!0,n.accept="*/*",n.onchange=r=>{const i=[];for(const s of r.target.files)i.push({file:s,file_name:s.name,file_size:s.size,file_type:ue(s.type),original_file_type:s.type});t(i)},n.click()}catch(n){e(n)}}),Ft=t=>t<1024?"".concat(t," B"):t<1024*1024?"".concat((t/1024).toFixed(2)," KB"):"".concat((t/1024/1024).toFixed(2)," MB"),Kt=t=>{t.preventDefault(),t.stopPropagation();const e=t.dataTransfer.files;return e.length>0?Array.from(e).map(r=>({file:r,file_name:r.name,file_size:r.size,file_type:ue(r.type)})):[]},qt=async t=>{try{if(!t||t.length===0)throw new Error(S.FILES_EMPTY);for(const e of t)if(!await Wt(e)){if(e.file.size>pe)throw new Error(S.FILE_SIZE_TOO_LARGE);if(!ge.includes(e.file.type))throw new Error(S.FILE_TYPE_NOT_ALLOWED)}return t}catch(e){return new Promise((n,r)=>{e.message===S.FILES_EMPTY?R.confirm({isShowCancelButton:!1,title:y("upload_files_title"),content:y("please_select_at_least_one_file_to_upload"),onOk:()=>{r(e)}}):e.message===S.FILE_TYPE_NOT_ALLOWED?R.confirm({title:y("upload_files_title"),content:y("please_select_only_allowed_file_types"),onOk:()=>{r(e)},isShowCancelButton:!1}):e.message===S.FILE_SIZE_TOO_LARGE?R.confirm({title:y("upload_files_title"),content:y("please_select_files_smaller_than_20mb"),onOk:()=>{r(e)},isShowCancelButton:!1}):r(e)})}},Wt=async t=>{try{return!(t.file.type!=="text/plain"||!(await t.file.text()).startsWith("# This data file generated by WeGene at"))}catch(e){return u.error("ERROR: isGeneticFile",e),!1}},Nt=B(me((t,e)=>({_uploadedFilesController:null,file_list:[],total:0,total_size:0,currentPage:1,pageSize:10,uploading_files:new Map,isLoading:!1,addUploadingFile:(n,r,i)=>{t(s=>{const o=i||h.getState().current_drive_user_id||"";if(!o){u.warn("useUploadStore::addUploadingFile - No userId provided, messageId: ".concat(n));return}s.uploading_files.has(o)||s.uploading_files.set(o,new Map),s.uploading_files.get(o).set(n,{...r,messageId:n,id:n,upload_status:"uploading",progress:0,message:"Starting upload...",isUploading:!0})})},updateUploadingProgress:(n,r,i,s,o)=>{t(a=>{const c=o||h.getState().current_drive_user_id||"";if(!c){u.warn("useUploadStore::updateUploadingProgress - No userId provided");return}const l=a.file_list.findIndex(d=>d.id===n);if(l!==-1){a.file_list[l].progress=r,a.file_list[l].upload_status=i,a.file_list[l].message=s;const d=a.uploading_files.get(c);d&&d.delete(n)}else{const d=a.uploading_files.get(c);if(d){const f=d.get(n);f&&(f.progress=r,f.upload_status=i,f.message=s)}}}),e().checkAndRefreshIfAllCompleted()},checkAndRefreshIfAllCompleted:()=>{const{uploading_files:n}=e(),r=h.getState().current_drive_user_id||"";if(!r)return;const i=n.get(r);if(!i||i.size===0)return;const s=a=>a==="complete"||a==="failed";Array.from(i.values()).every(a=>s(a.upload_status))&&(e().clearUploadingFiles(),e().fetchFileList())},removeUploadingFile:(n,r)=>{n&&t(i=>{const s=r||h.getState().current_drive_user_id||"";if(s){const o=i.uploading_files.get(s);o&&o.delete(n)}})},clearUploadingFiles:n=>{t(r=>{const i=n||h.getState().current_drive_user_id||"";i&&r.uploading_files.delete(i)})},getUploadingFilesForCurrentUser:()=>{const{uploading_files:n}=e(),r=h.getState().current_drive_user_id||"";return r?n.get(r)||new Map:new Map},fetchFileList:async()=>{const{_uploadedFilesController:n,currentPage:r,pageSize:i}=e();n&&n.abort();const s=new AbortController;t(o=>{o._uploadedFilesController=s,o.isLoading=!0,o.file_list=[]});try{const{current_drive_user_id:o}=h.getState(),{user_id:a}=Ut.getState(),c=(r-1)*i,l={limit:i,offset:c,signal:s.signal};o&&o!==a&&(l.user_id=o);const{files:d,total:f,total_size:g}=await J.getUploadedFiles(l);t(C=>{C.file_list=d.map(K=>({...K,show_file_size:Ft(K.file_size)})),C.total=f,C.total_size=g,C.isLoading=!1,C._uploadedFilesController=null})}catch(o){if(o.name==="AbortError"||o.name==="CanceledError")return;u.error("ERROR: fetchFileList",o),t(a=>{a.isLoading=!1,a._uploadedFilesController=null})}},setPage:n=>{t(r=>{r.currentPage=n}),e().fetchFileList()},setPageWithoutFetch:n=>{t(r=>{r.currentPage=n})},setPageSize:n=>{t(r=>{r.currentPage=1,r.pageSize=n}),e().fetchFileList()},nextPage:()=>{const{currentPage:n,total:r,pageSize:i}=e(),s=Math.ceil(r/i);n<s&&(t(o=>{o.currentPage=n+1}),e().fetchFileList())},prevPage:()=>{const{currentPage:n}=e();n>1&&(t(r=>{r.currentPage=n-1}),e().fetchFileList())}}))),h=B((t,e)=>({current_drive_user_id:localStorage.getItem(b)||"",setCurrentDriveUserId:n=>{const r=e().current_drive_user_id;t({current_drive_user_id:n}),r!==n&&n&&(Rt().getConnection(n),Nt.getState().clearUploadingFiles())}})),Ut=B((t,e)=>({_beneficiaryUsersController:null,user_id:localStorage.getItem(b)||"",user_email:localStorage.getItem(W)||"",user_name:localStorage.getItem(I)||"",setUserInfo:n=>{localStorage.setItem(I,n.name||""),localStorage.setItem(W,n.email||""),localStorage.setItem(b,n.user_id||""),t({user_name:n.name||"",user_email:n.email||"",user_id:n.user_id||""}),h.getState().setCurrentDriveUserId(n.user_id||"")},beneficiary_users:[{id:localStorage.getItem(b)||"",name:localStorage.getItem(I)||"",email:localStorage.getItem(W)||"",is_current_user:!0}],setBeneficiaryUsers:n=>{t({beneficiary_users:n})},fetchBeneficiaryUsers:async()=>{const{_beneficiaryUsersController:n}=e();n&&n.abort();const r=new AbortController;t({_beneficiaryUsersController:r});const i=r.signal;try{const s=await J.beneficiaryUsers(i);t({beneficiary_users:s,_beneficiaryUsersController:null});const o=s.find(a=>a.is_current_user);if(o){const{user_id:a}=e();a||(t({user_id:o.id,user_name:o.name}),localStorage.setItem(b,o.id||""),localStorage.setItem(I,o.name||""));const{current_drive_user_id:c}=h.getState();c||h.getState().setCurrentDriveUserId(o.id)}return s}catch(s){if(s.name==="AbortError"||s.name==="CanceledError")return;u.error("ERROR: fetchBeneficiaryUsers",s)}},current_query_user_id:localStorage.getItem(D)||localStorage.getItem(b)||"",current_query_user_name:localStorage.getItem(F)||localStorage.getItem(I)||"",setCurrentQueryUser:({user_id:n,user_name:r})=>{localStorage.setItem(D,n||""),localStorage.setItem(F,r||""),t({current_query_user_id:n||"",current_query_user_name:r||""})},setCurrentQueryUserByUserId:n=>{if(!n)return;const{beneficiary_users:r}=e(),i=r.find(s=>s.id===n);i&&(t({current_query_user_id:i.id||"",current_query_user_name:i.name||""}),localStorage.setItem(D,i.id||""),localStorage.setItem(F,i.name||""))}}));export{h as a,Nt as b,ue as c,Ft as f,Rt as g,Kt as h,$t as o,Ut as u,qt as v};
