name: PyPI Release

# Trigger conditions: push tag or manual trigger
on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+-*'  # Support pre-release versions like 1.0.0-beta1
  workflow_dispatch:  # Allow manual trigger
    inputs:
      test_mode:
        description: 'Test mode (do not publish to PyPI, do not create Release)'
        required: false
        default: 'true'  # Default to test mode
        type: choice
        options:
          - 'true'
          - 'false'
      version_suffix:
        description: 'Version suffix (optional, e.g., dev1, test2)'
        required: false
        default: 'test'
      target_branch:
        description: 'Display current running branch (for reference only, select branch on Actions page)'
        required: false
        default: 'Select branch on Actions page'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools wheel

    # Install package dependencies for testing
    - name: Install package dependencies
      run: |
        pip install -e .
      continue-on-error: true  # Some dependencies may not be available in CI environment

    # Run basic import test
    - name: Test package import
      run: |
        python -c "import mirobody; print(f'Mirobody imported successfully')"
      continue-on-error: true

    # Get version from tag or use test version
    - name: Set version from tag or manual trigger
      run: |
        if [[ "$GITHUB_REF" == refs/tags/* ]]; then
          # If it's a tag, use tag name as version
          VERSION=${GITHUB_REF#refs/tags/}
          echo "ðŸŽ¯ Running on tag: $VERSION"
        else
          # If manually triggered, generate test version number
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          VERSION_SUFFIX="${{ github.event.inputs.version_suffix }}"

          if [ -n "$VERSION_SUFFIX" ]; then
            VERSION="0.0.0.dev${TIMESTAMP}.${BRANCH_NAME}.${VERSION_SUFFIX}"
          else
            VERSION="0.0.0.dev${TIMESTAMP}.${BRANCH_NAME}.${SHORT_SHA}"
          fi

          echo "ðŸ§ª Manual test trigger on branch: $BRANCH_NAME"
          echo "ðŸ“¦ Test version: $VERSION"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Setting version to $VERSION"
        sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" mirobody/__init__.py
        cat mirobody/__init__.py

    # Build Python package
    - name: Build package
      run: |
        python -m build
        ls -la dist/

    # Verify package contents
    - name: Check package
      run: |
        pip install twine
        twine check dist/*

    # Test package installation
    - name: Test package installation
      run: |
        pip install dist/*.whl
        python -c "import mirobody; print(f'Version: {mirobody.__version__}')"
        pip uninstall -y mirobody

    # Upload to TestPyPI
    - name: Publish to TestPyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "Uploading to TestPyPI..."
        twine upload --repository testpypi dist/* || echo "TestPyPI upload failed (may already exist)"
      continue-on-error: true

    # Upload to PyPI (only for official tags, and not in test mode)
    - name: Publish to PyPI
      if: startsWith(github.ref, 'refs/tags/') && github.event.inputs.test_mode != 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Uploading to PyPI..."
        twine upload --repository pypi dist/*
      continue-on-error: true

    # Generate intelligent Release Notes
    - name: Generate Release Notes
      id: release_notes
      run: |
        # Get previous tag (if exists)
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        CURRENT_TAG=${{ env.VERSION }}

        echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV
        echo "CURRENT_TAG=$CURRENT_TAG" >> $GITHUB_ENV

        # Create release notes file
        cat > release_notes.md << 'EOF'
        ## ðŸš€ What's New in v${{ env.VERSION }}

        EOF

        # Get tag message (if it's an annotated tag)
        TAG_MESSAGE=$(git tag -l --format='%(contents)' $CURRENT_TAG 2>/dev/null | head -n 10)
        if [ ! -z "$TAG_MESSAGE" ]; then
          echo "### ðŸ“ Release Message" >> release_notes.md
          echo "$TAG_MESSAGE" >> release_notes.md
          echo "" >> release_notes.md
        fi

        # Generate change list (based on commits)
        if [ ! -z "$PREVIOUS_TAG" ]; then
          echo "### ðŸ“‹ Changes Since $PREVIOUS_TAG" >> release_notes.md
          echo "" >> release_notes.md

          # Categorize commits by type
          echo "#### ðŸ†• New Features" >> release_notes.md
          git log --oneline --grep="feat:" --grep="feature:" --grep="add:" --grep="æ–°å¢ž" --grep="åŠŸèƒ½" $PREVIOUS_TAG..HEAD | sed 's/^/- /' >> release_notes.md || echo "- No new features" >> release_notes.md
          echo "" >> release_notes.md

          echo "#### ðŸ› Bug Fixes" >> release_notes.md
          git log --oneline --grep="fix:" --grep="bug:" --grep="ä¿®å¤" --grep="bugfix" $PREVIOUS_TAG..HEAD | sed 's/^/- /' >> release_notes.md || echo "- No bug fixes" >> release_notes.md
          echo "" >> release_notes.md

          echo "#### ðŸ”§ Improvements" >> release_notes.md
          git log --oneline --grep="improve:" --grep="update:" --grep="ä¼˜åŒ–" --grep="æ”¹è¿›" $PREVIOUS_TAG..HEAD | sed 's/^/- /' >> release_notes.md || echo "- No improvements" >> release_notes.md
          echo "" >> release_notes.md

          echo "#### ðŸ“š Documentation" >> release_notes.md
          git log --oneline --grep="docs:" --grep="doc:" --grep="æ–‡æ¡£" $PREVIOUS_TAG..HEAD | sed 's/^/- /' >> release_notes.md || echo "- No documentation changes" >> release_notes.md
          echo "" >> release_notes.md

          echo "#### ðŸ”¨ Other Changes" >> release_notes.md
          git log --oneline --invert-grep --grep="feat:" --grep="fix:" --grep="docs:" --grep="improve:" --grep="update:" --grep="åŠŸèƒ½" --grep="ä¿®å¤" --grep="æ–‡æ¡£" --grep="ä¼˜åŒ–" $PREVIOUS_TAG..HEAD | sed 's/^/- /' >> release_notes.md || echo "- No other changes" >> release_notes.md
          echo "" >> release_notes.md

          # Get related PR information
          echo "#### ðŸ”— Related Pull Requests" >> release_notes.md

          # Get PRs merged in this release
          PR_NUMBERS=$(git log --oneline --merges $PREVIOUS_TAG..HEAD | grep -o "#[0-9]\+" | sort -u | head -10)

          if [ ! -z "$PR_NUMBERS" ]; then
            echo "$PR_NUMBERS" | while read pr_num; do
              # Use GitHub CLI to get PR details (if available)
              if command -v gh >/dev/null 2>&1; then
                PR_TITLE=$(gh pr view "${pr_num/\#/}" --json title -q '.title' 2>/dev/null || echo "")
                PR_URL="https://github.com/${{ github.repository }}/pull/${pr_num/\#/}"
                if [ ! -z "$PR_TITLE" ]; then
                  echo "- [$PR_TITLE]($PR_URL) $pr_num" >> release_notes.md
                else
                  echo "- $pr_num" >> release_notes.md
                fi
              else
                PR_URL="https://github.com/${{ github.repository }}/pull/${pr_num/\#/}"
                echo "- [$pr_num]($PR_URL)" >> release_notes.md
              fi
            done
          else
            echo "- No pull requests merged" >> release_notes.md
          fi
          echo "" >> release_notes.md

          # Get contributor information
          echo "#### ðŸ‘¥ Contributors" >> release_notes.md
          CONTRIBUTORS=$(git log --format='%an <%ae>' $PREVIOUS_TAG..HEAD | sort -u | head -10)
          if [ ! -z "$CONTRIBUTORS" ]; then
            echo "$CONTRIBUTORS" | while read contributor; do
              echo "- $contributor" >> release_notes.md
            done
          else
            echo "- No contributors found" >> release_notes.md
          fi
          echo "" >> release_notes.md

          # Statistics
          COMMIT_COUNT=$(git rev-list --count $PREVIOUS_TAG..HEAD)
          FILES_CHANGED=$(git diff --name-only $PREVIOUS_TAG..HEAD | wc -l)

          echo "#### ðŸ“Š Release Statistics" >> release_notes.md
          echo "- **Commits**: $COMMIT_COUNT" >> release_notes.md
          echo "- **Files Changed**: $FILES_CHANGED" >> release_notes.md
          echo "- **Period**: $(git log -1 --format='%ai' $PREVIOUS_TAG) â†’ $(git log -1 --format='%ai' HEAD)" >> release_notes.md
          echo "" >> release_notes.md

        else
          echo "### ðŸŽ‰ First Release" >> release_notes.md
          echo "This is the initial release of Mirobody package." >> release_notes.md
          echo "" >> release_notes.md

          # Show recent commits
          echo "#### ðŸ“‹ Recent Changes" >> release_notes.md
          git log --oneline -n 10 | sed 's/^/- /' >> release_notes.md
        fi

        # Add installation instructions
        cat >> release_notes.md << 'EOF'

        ## ðŸ“¦ Installation

        ### From TestPyPI:
        ```bash
        pip install -i https://test.pypi.org/simple/ mirobody==${{ env.VERSION }}
        ```

        ### From PyPI:
        ```bash
        pip install mirobody==${{ env.VERSION }}
        ```

        ### From GitHub Release:
        ```bash
        pip install https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/mirobody-${{ env.VERSION }}-py3-none-any.whl
        ```

        ### From Source:
        ```bash
        git clone https://github.com/${{ github.repository }}.git
        cd mirobody
        pip install .
        ```

        ## ðŸ” Package Details

        - **Version**: ${{ env.VERSION }}
        - **Release Date**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **Commit**: ${{ github.sha }}
        - **Python Support**: 3.8+
        - **Platforms**: Linux, macOS, Windows

        EOF

        # Output generated content for debugging
        echo "Generated release notes:"
        cat release_notes.md

    # Create GitHub Release (only for tags, and not in test mode)
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/') && github.event.inputs.test_mode != 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(env.VERSION, 'a') || contains(env.VERSION, 'b') || contains(env.VERSION, 'rc') || contains(env.VERSION, 'dev') }}
        tag_name: ${{ env.VERSION }}
        name: "Release v${{ env.VERSION }}"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Optional: Print installation instructions
    - name: Print installation instructions
      run: |
        echo "ðŸŽ‰ Release $VERSION completed!"
        echo ""
        echo "ðŸ“¦ Install from TestPyPI:"
        echo "pip install -i https://test.pypi.org/simple/ mirobody==$VERSION"
        echo ""
        echo "ðŸ“¦ Install from PyPI:"
        echo "pip install mirobody==$VERSION"
        echo ""
        echo "ðŸ“¦ Or download from GitHub Release:"
        echo "https://github.com/${{ github.repository }}/releases/tag/$VERSION"